<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Spring Boot-高级篇 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="(一) Spring Boot与缓存一、 JSR107Java Caching定义了5个核心接口  CachingProvider 定义了创建、配置、获取、管理和控制多个CacheManager。一个应用可以在运行期访问多个CachingProvider。  CacheManager 定义了创建、配置、获取、管理和控制多个唯一命名的Cache，这些Cache存在于CacheManager的上下文中">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Boot-高级篇">
<meta property="og:url" content="http://example.com/2020/10/26/Spring%20Boot-%E9%AB%98%E7%BA%A7%E7%AF%87/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="(一) Spring Boot与缓存一、 JSR107Java Caching定义了5个核心接口  CachingProvider 定义了创建、配置、获取、管理和控制多个CacheManager。一个应用可以在运行期访问多个CachingProvider。  CacheManager 定义了创建、配置、获取、管理和控制多个唯一命名的Cache，这些Cache存在于CacheManager的上下文中">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2020/10/03/9dV8CXpjDPAYL74.png">
<meta property="og:image" content="https://i.loli.net/2020/10/03/yZPaFYGqrsUv8IE.png">
<meta property="og:image" content="http://example.com/2020/10/26/Spring%20Boot-%E9%AB%98%E7%BA%A7%E7%AF%87/QQ%E6%88%AA%E5%9B%BE20201018162618.png">
<meta property="og:image" content="https://i.loli.net/2020/10/03/nbJN45z6D3uEs97.png">
<meta property="og:image" content="https://i.loli.net/2020/10/03/HMk4oKfBCsjm2cY.png">
<meta property="og:image" content="https://i.loli.net/2020/10/03/qWTQo5azcxihAVU.png">
<meta property="og:image" content="https://i.loli.net/2020/10/03/xvz4jRmI1hc2QGw.png">
<meta property="og:image" content="https://i.loli.net/2020/10/03/VIEF9woJaGchQpW.png">
<meta property="og:image" content="https://i.loli.net/2020/10/03/mkn8LVQUiTxphsq.png">
<meta property="og:image" content="https://i.loli.net/2020/10/03/w7ktlPEOAZeUMdQ.png">
<meta property="og:image" content="https://i.loli.net/2020/10/03/zcLPnRNXvq2uHoE.png">
<meta property="og:image" content="https://i.loli.net/2020/10/03/kDuYetTVZ6arn2z.png">
<meta property="article:published_time" content="2020-10-26T05:47:26.000Z">
<meta property="article:modified_time" content="2020-10-26T05:57:03.697Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/10/03/9dV8CXpjDPAYL74.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Spring Boot-高级篇" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/26/Spring%20Boot-%E9%AB%98%E7%BA%A7%E7%AF%87/" class="article-date">
  <time datetime="2020-10-26T05:47:26.000Z" itemprop="datePublished">2020-10-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Spring Boot-高级篇
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="一-Spring-Boot与缓存"><a href="#一-Spring-Boot与缓存" class="headerlink" title="(一) Spring Boot与缓存"></a>(一) Spring Boot与缓存</h1><h2 id="一、-JSR107"><a href="#一、-JSR107" class="headerlink" title="一、 JSR107"></a>一、 JSR107</h2><p>Java Caching定义了5个核心接口</p>
<ul>
<li><p>CachingProvider</p>
<p>定义了创建、配置、获取、管理和控制多个CacheManager。一个应用可<br>以在运行期访问多个CachingProvider。</p>
</li>
<li><p>CacheManager</p>
<p>定义了创建、配置、获取、管理和控制多个唯一命名的Cache，这些Cache<br>存在于CacheManager的上下文中。一个CacheManager仅被一个CachingProvider所拥有。</p>
</li>
<li><p>Cache</p>
<p>一个类似<strong>Map</strong>的数据结构并<strong>临时存储以Key为索引</strong>的值。一个Cache仅被一个<br>CacheManager所拥有。</p>
</li>
<li><p>Entry</p>
<p>一个存储在Cache中的key-value对。</p>
</li>
<li><p>Expiry</p>
<p>每一个存储在Cache中的条目有一个定义的有效期。一旦超过这个时间，条目为过期的状态。一旦过期，条目将不可访问、更新和删除。缓存有效期可以通过ExpiryPolicy设置。</p>
<p><img src="https://i.loli.net/2020/10/03/9dV8CXpjDPAYL74.png" alt="jsr107示意图"></p>
</li>
</ul>
<h2 id="二、-Spring缓存抽象"><a href="#二、-Spring缓存抽象" class="headerlink" title="二、 Spring缓存抽象"></a>二、 Spring缓存抽象</h2><p>  Spring从3.1开始定义了org.springframework.cache.Cache<br>  和org.springframework.cache.CacheManager接口来<strong>统一</strong>不同的缓存技术；<br>  <strong>并支持使用JCache（JSR-107）</strong>注解简化我们开发；</p>
<p>  Cache接口有以下功能：</p>
<ul>
<li><p>为缓存的组件规范定义，包含缓存的各种操作集合；</p>
</li>
<li><p>Spring提供了各种xxxCache的实现；如RedisCache，EhCacheCache ,<br>ConcurrentMapCache等；</p>
<p><img src="https://i.loli.net/2020/10/03/yZPaFYGqrsUv8IE.png" alt="Spring缓存抽象"></p>
</li>
</ul>
<h2 id="三、-重要缓存注解及概念"><a href="#三、-重要缓存注解及概念" class="headerlink" title="三、 重要缓存注解及概念"></a>三、 重要缓存注解及概念</h2><table>
<thead>
<tr>
<th align="left"><strong>Cache</strong></th>
<th><strong>缓存接口，定义缓存操作。实现有：RedisCache、EhCacheCache、ConcurrentMapCache等</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>CacheManager</strong></td>
<td><strong>缓存管理器，管理各种缓存（Cache）组件</strong></td>
</tr>
<tr>
<td align="left"><strong>@Cacheable</strong></td>
<td><strong>根据方法的请求参数对其结果进行缓存</strong></td>
</tr>
<tr>
<td align="left"><strong>@CacheEvict</strong></td>
<td><strong>清空缓存</strong></td>
</tr>
<tr>
<td align="left"><strong>@CachePut</strong></td>
<td><strong>更新缓存</strong></td>
</tr>
<tr>
<td align="left"><strong>@EnableCaching</strong></td>
<td><strong>开启基于注解的缓存</strong></td>
</tr>
<tr>
<td align="left"><strong>keyGenerator</strong></td>
<td><strong>缓存数据时key生成策略</strong></td>
</tr>
<tr>
<td align="left"><strong>serialize</strong></td>
<td><strong>缓存数据时value序列化策略</strong></td>
</tr>
</tbody></table>
<h3 id="1-Cacheable-CachePut-CacheEvict-主要的参数"><a href="#1-Cacheable-CachePut-CacheEvict-主要的参数" class="headerlink" title="1 . @Cacheable/@CachePut/@CacheEvict 主要的参数"></a>1 . @Cacheable/@CachePut/@CacheEvict 主要的参数</h3><ul>
<li><p><strong>value</strong></p>
<p>缓存名称，字符串/字符数组形式；</p>
<p>如@Cacheable(value=”mycache”) 或者@Cacheable(value={”cache1”,”cache2”}</p>
</li>
<li><p><strong>key</strong></p>
<p>缓存的key,需要按照SpEL表达式编写，如果不指定则按照方法所有参数进行组合；</p>
<p>如@Cacheable(value=”testcache”,key=”#userName”)</p>
</li>
<li><p><strong>keyGenerator</strong></p>
<p>key的生成器；可以自己指定key的生成器的组件id</p>
<p>注意：key/keyGenerator：二选一使用;</p>
</li>
<li><p><strong>condition</strong></p>
<p>缓存条件，使用SpEL编写，在调用方法之前之后都能判断；</p>
<p>如@Cacheable(value=”testcache”,condition=”#userName.length()&gt;2”)</p>
</li>
<li><p><strong>unless</strong>（@CachePut、@Cacheable）</p>
<p>用于否决缓存的条件，只在方法执行之后判断；</p>
<p>如@Cacheable(value=”testcache”,unless=”#result ==null”)</p>
</li>
<li><p><strong>beforeInvocation</strong>（@CacheEvict）</p>
<p>是否在执行前清空缓存，默认为false，false情况下方法执行异常则不会清空；</p>
<p>如@CachEvict(value=”testcache”，beforeInvocation=true)</p>
</li>
<li><p><strong>allEntries</strong>（@CacheEvict）</p>
<p>是否清空所有缓存内容，默认为false；</p>
<p>如@CachEvict(value=”testcache”,allEntries=true)</p>
</li>
</ul>
<h3 id="2-缓存可用的SpEL表达式"><a href="#2-缓存可用的SpEL表达式" class="headerlink" title="2 . 缓存可用的SpEL表达式"></a>2 . 缓存可用的SpEL表达式</h3><p><img src="/2020/10/26/Spring%20Boot-%E9%AB%98%E7%BA%A7%E7%AF%87/QQ%E6%88%AA%E5%9B%BE20201018162618.png"></p>
 

<p><strong>root</strong></p>
<p>表示根对象，不可省略</p>
<ul>
<li><p>被调用方法名                        <strong>methodName</strong> </p>
<p>如 #root.methodName</p>
</li>
<li><p>被调用方法                            <strong>method</strong></p>
<p>如 #root.method.name</p>
</li>
<li><p>目标对象                               <strong>target</strong></p>
<p>如 #root.target</p>
</li>
<li><p>被调用的目标对象类           <strong>targetClass</strong></p>
<p>如 #root.targetClass</p>
</li>
<li><p>被调用的方法的参数列表      <strong>args</strong>    </p>
<p>如 #root.args[0]</p>
</li>
<li><p>方法调用使用的缓存列表      <strong>caches</strong></p>
<p>如 #root.caches[0].name</p>
</li>
</ul>
<p><strong>参数名</strong></p>
<p>方法参数的名字. 可以直接 #参数名 ，也可以使用 #p0或#a0 的形式，0代表参数的索引；</p>
<p>如 #iban 、 #a0 、 #p0</p>
<p><strong>返回值</strong></p>
<p>方法执行后的返回值（仅当方法执行之后的判断有效，如‘unless’ ， @CachePut、@CacheEvict’的表达式beforeInvocation=false ）</p>
<p>如 #result</p>
<h2 id="四、-缓存使用"><a href="#四、-缓存使用" class="headerlink" title="四、 缓存使用"></a>四、 缓存使用</h2><h3 id="1-基本使用步骤"><a href="#1-基本使用步骤" class="headerlink" title="1. 基本使用步骤"></a>1. 基本使用步骤</h3><ol>
<li>引入spring-boot-starter-cache模块</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>@EnableCaching开启缓存</p>
<p>在主配置类上标注</p>
</li>
<li><p>使用缓存注解</p>
<p>如@Cacheable、@CachePut</p>
</li>
<li><p>切换为其他缓存</p>
</li>
</ol>
<h3 id="2-搭建实验环境"><a href="#2-搭建实验环境" class="headerlink" title="2. 搭建实验环境"></a>2. 搭建实验环境</h3><ol>
<li><p>导入数据库文件 创建出department和employee表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for department</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`department`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`department`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`departmentName`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for employee</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`employee`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`employee`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`lastName`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`email`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`gender`</span> <span class="built_in">int</span>(<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`d_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建javaBean封装数据</p>
</li>
<li><p>整合MyBatis操作数据库</p>
<p>配置数据源信息</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource.password</span>=<span class="string">123</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/springboot?serverTimezone=GMT</span></span><br><span class="line"><span class="meta">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启驼峰命名法(否则部分字段封装不了)</span></span><br><span class="line"><span class="meta">mybatis.configuration.map-underscore-to-camel-case</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#打印sql</span></span><br><span class="line"><span class="meta">logging.level.cn.edu.ustc.springboot.mapper</span>=<span class="string">debug</span></span><br><span class="line"></span><br><span class="line"><span class="attr">debug</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>使用注解版的MyBatis；</p>
<p>​    @MapperScan指定需要扫描的mapper接口所在的包</p>
</li>
<li><p>主配置类开启@EnableCaching</p>
</li>
</ol>
<h3 id="3-快速体验缓存"><a href="#3-快速体验缓存" class="headerlink" title="3. 快速体验缓存"></a>3. 快速体验缓存</h3><p><strong>@Cacheable、@CachePut、@CacheEvict的使用</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmployeeService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeMapper employeeMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Cacheable(value=&#123;&quot;emp&quot;&#125;,</span></span><br><span class="line"><span class="meta">            key = &quot;#id+#root.methodName+#root.caches[0].name&quot;,</span></span><br><span class="line"><span class="meta">            condition = &quot;#a0&gt;1&quot;,</span></span><br><span class="line"><span class="meta">            unless = &quot;#p0==2&quot;</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Employee <span class="title">getEmpById</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;查询员工：&quot;</span>+id);</span><br><span class="line">        <span class="keyword">return</span> employeeMapper.getEmpById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CachePut(value = &#123;&quot;emp&quot;&#125;,key = &quot;#employee.id&quot; )</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Employee <span class="title">updateEmp</span><span class="params">(Employee employee)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;更新员工&quot;</span>+employee);</span><br><span class="line">        employeeMapper.updateEmp(employee);</span><br><span class="line">        <span class="keyword">return</span> employee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CacheEvict(value = &#123;&quot;emp&quot;&#125;,allEntries = true,beforeInvocation = true)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">delEmp</span><span class="params">(Integer id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i=<span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;删除员工：&quot;</span>+id);</span><br><span class="line">        employeeMapper.delEmp(id);</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>自定义KeyGenerator</strong></p>
<p>使用时在注解属性内指定KeyGenerator=“myKeyGenerator”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCacheConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean(&quot;myKeyGenerator&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeyGenerator <span class="title">myKeyGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> KeyGenerator()&#123;</span><br><span class="line">           <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> target 添加注解方法所在类的对象</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> method 添加注解的方法</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> params 添加注解方法的参数</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">generate</span><span class="params">(Object target, Method method, Object... params)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> method.getName()+<span class="string">&quot;[&quot;</span>+ Arrays.asList(params).toString()+<span class="string">&quot;----&quot;</span>+target+<span class="string">&quot;]&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>@CacheConfig</strong></p>
<p>标注在类上，用于抽取@Cacheable的公共属性</p>
<p>由于一个类中可能会使用多次@Cacheable等注解，所以各项属性可以抽取到@CacheConfig</p>
<p><strong>@Caching</strong></p>
<p>组合使用@Cacheable、@CachePut、@CacheEvict</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Caching(</span></span><br><span class="line"><span class="meta">       cacheable = &#123;</span></span><br><span class="line"><span class="meta">           @Cacheable(/*value=&quot;emp&quot;,*/key = &quot;#lastName&quot;)</span></span><br><span class="line"><span class="meta">       &#125;,</span></span><br><span class="line"><span class="meta">       put = &#123;</span></span><br><span class="line"><span class="meta">           @CachePut(/*value=&quot;emp&quot;,*/key = &quot;#result.id&quot;),</span></span><br><span class="line"><span class="meta">           @CachePut(/*value=&quot;emp&quot;,*/key = &quot;#result.email&quot;)</span></span><br><span class="line"><span class="meta">       &#125;</span></span><br><span class="line"><span class="meta">  )</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Employee <span class="title">getEmpByLastName</span><span class="params">(String lastName)</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> employeeMapper.getEmpByLastName(lastName);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-工作原理"><a href="#4-工作原理" class="headerlink" title="4. 工作原理"></a>4. 工作原理</h3><p>缓存的自动配置类CacheAutoConfiguration向容器中导入了CacheConfigurationImportSelector，此类的selectImports()方法添加了许多配置类，其中SimpleCacheConfiguration默认生效</p>
<p>​    GenericCacheConfiguration<br>​    JCacheCacheConfiguration<br>​    EhCacheCacheConfiguration<br>​    HazelcastCacheConfiguration<br>​    InfinispanCacheConfiguration<br>​    CouchbaseCacheConfiguration<br>​    RedisCacheConfiguration<br>​    CaffeineCacheConfiguration<br>​    GuavaCacheConfiguration<br>​    SimpleCacheConfiguration【默认】<br>​    NoOpCacheConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Import(&#123; CacheConfigurationImportSelector.class, CacheManagerEntityManagerFactoryDependsOnPostProcessor.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheAutoConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheConfigurationImportSelector</span> <span class="keyword">implements</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">			CacheType[] types = CacheType.values();</span><br><span class="line">			String[] imports = <span class="keyword">new</span> String[types.length];</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; types.length; i++) &#123;</span><br><span class="line">                <span class="comment">//将即将导入的各配置类存入字符数组内</span></span><br><span class="line">				imports[i] = CacheConfigurations.getConfigurationClass(types[i]);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> imports;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SimpleCacheConfiguration向容器中导入了ConcurrentMapCacheManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(CacheManager.class)</span></span><br><span class="line"><span class="meta">@Conditional(CacheCondition.class)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleCacheConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="comment">//向容器中导入ConcurrentMapCacheManager</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function">ConcurrentMapCacheManager <span class="title">cacheManager</span><span class="params">(CacheProperties cacheProperties,</span></span></span><br><span class="line"><span class="function"><span class="params">			CacheManagerCustomizers cacheManagerCustomizers)</span> </span>&#123;</span><br><span class="line">		ConcurrentMapCacheManager cacheManager = <span class="keyword">new</span> ConcurrentMapCacheManager();</span><br><span class="line">		List&lt;String&gt; cacheNames = cacheProperties.getCacheNames();</span><br><span class="line">		<span class="keyword">if</span> (!cacheNames.isEmpty()) &#123;</span><br><span class="line">			cacheManager.setCacheNames(cacheNames);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> cacheManagerCustomizers.customize(cacheManager);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ConcurrentMapCacheManager使用ConcurrentMap以k-v的方式存储缓存缓存，下面以@Cacheable的运行流程为例说明ConcurrentMapCacheManager的作用。</p>
<p><strong>==@Cacheable的运行流程==</strong></p>
<ol>
<li><p>方法运行之前，先去查询Cache（缓存组件），<strong>按照cacheNames指定的名字获取</strong>；<br>（CacheManager先获取相应的缓存），第一次获取缓存如果没有Cache组件会自动创建,并以cacheNames-cache对放入ConcurrentMap。</p>
</li>
<li><p>去Cache中查找缓存的内容，使用一个key，默认就是方法的参数；<br><strong>key是按照某种策略生成的</strong>；默认是使用keyGenerator生成的，默认使用SimpleKeyGenerator生成key；</p>
<p>​    SimpleKeyGenerator生成key的默认策略；</p>
<p>​        如果没有参数；key=new SimpleKey()；<br>​        如果有一个参数：key=参数的值<br>​        如果有多个参数：key=new SimpleKey(params)；</p>
</li>
<li><p>没有查到缓存就调用目标方法；</p>
</li>
<li><p>将目标方法返回的结果，放进缓存中</p>
</li>
</ol>
<p>@Cacheable标注的方法执行之前先来检查缓存中有没有这个数据，默认按照参数的值作为key去查询缓存，<br>如果没有就运行方法并将结果放入缓存；以后再来调用就可以直接使用缓存中的数据；</p>
<p>核心：<br>1）、使用CacheManager【ConcurrentMapCacheManager】按照名字得到Cache【ConcurrentMapCache】组件<br>2）、key使用keyGenerator生成的，默认是SimpleKeyGenerator</p>
<p><strong>源码分析</strong></p>
<p>默认使用ConcurrentMapCacheManager管理缓存，该类使用ConcurrentMap保存缓存，获取缓存如果没有Cache组件会自动创建,并以cacheNames-cache对放入ConcurrentMap。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentMapCacheManager</span> <span class="keyword">implements</span> <span class="title">CacheManager</span>, <span class="title">BeanClassLoaderAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, Cache&gt; cacheMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> dynamic = <span class="keyword">true</span>;</span><br><span class="line">    </span><br><span class="line">   <span class="comment">//获取缓存</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Cache <span class="title">getCache</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		Cache cache = <span class="keyword">this</span>.cacheMap.get(name);</span><br><span class="line">        <span class="comment">//如果没有缓存会自动创建</span></span><br><span class="line">		<span class="keyword">if</span> (cache == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.dynamic) &#123;</span><br><span class="line">			<span class="keyword">synchronized</span> (<span class="keyword">this</span>.cacheMap) &#123;</span><br><span class="line">				cache = <span class="keyword">this</span>.cacheMap.get(name);</span><br><span class="line">				<span class="keyword">if</span> (cache == <span class="keyword">null</span>) &#123;</span><br><span class="line">					cache = createConcurrentMapCache(name);</span><br><span class="line">					<span class="keyword">this</span>.cacheMap.put(name, cache);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> cache;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在@Cacheable标注方法执行前执行CacheAspectSupport的execute()方法，在该方法中会以一定的规则生成key，并尝试在缓存中通过该key获取值，若通过key获取到值则直接返回，不用执行@Cacheable标注方法，否则执行该方法获得返回值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheAspectSupport</span> <span class="keyword">extends</span> <span class="title">AbstractCacheInvoker</span></span></span><br><span class="line"><span class="class">		<span class="keyword">implements</span> <span class="title">BeanFactoryAware</span>, <span class="title">InitializingBean</span>, <span class="title">SmartInitializingSingleton</span> </span>&#123;</span><br><span class="line">    <span class="comment">//在执行@Cacheable标注的方法前执行此方法</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> Object <span class="title">execute</span><span class="params">(<span class="keyword">final</span> CacheOperationInvoker invoker, Method method, CacheOperationContexts contexts)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (contexts.isSynchronized()) &#123;</span><br><span class="line">			CacheOperationContext context = contexts.get(CacheableOperation.class).iterator().next();</span><br><span class="line">			<span class="keyword">if</span> (isConditionPassing(context, CacheOperationExpressionEvaluator.NO_RESULT)) &#123;</span><br><span class="line">				Object key = generateKey(context, CacheOperationExpressionEvaluator.NO_RESULT);</span><br><span class="line">				Cache cache = context.getCaches().iterator().next();</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> wrapCacheValue(method, cache.get(key, () -&gt; unwrapReturnValue(invokeOperation(invoker))));</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (Cache.ValueRetrievalException ex) &#123;</span><br><span class="line">					<span class="keyword">throw</span> (CacheOperationInvoker.ThrowableWrapper) ex.getCause();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> invokeOperation(invoker);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">		processCacheEvicts(contexts.get(CacheEvictOperation.class), <span class="keyword">true</span>,</span><br><span class="line">				CacheOperationExpressionEvaluator.NO_RESULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 见findCachedItem方法</span></span><br><span class="line">        <span class="comment">//此方法通过一定规则生成的key找cache，若没找到则返回null</span></span><br><span class="line">		Cache.ValueWrapper cacheHit = findCachedItem(contexts.get(CacheableOperation.class));</span><br><span class="line"></span><br><span class="line">		List&lt;CachePutRequest&gt; cachePutRequests = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">		<span class="keyword">if</span> (cacheHit == <span class="keyword">null</span>) &#123;</span><br><span class="line">			collectPutRequests(contexts.get(CacheableOperation.class),</span><br><span class="line">					CacheOperationExpressionEvaluator.NO_RESULT, cachePutRequests);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Object cacheValue;</span><br><span class="line">		Object returnValue;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (cacheHit != <span class="keyword">null</span> &amp;&amp; !hasCachePut(contexts)) &#123;</span><br><span class="line">			<span class="comment">// 如果通过该key找到缓存，且无@cacheput,则直接返回cacheValue</span></span><br><span class="line">			cacheValue = cacheHit.get();</span><br><span class="line">			returnValue = wrapCacheValue(method, cacheValue);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// 若通过该key未找到缓存，则执行@cacheable标注方法</span></span><br><span class="line">			returnValue = invokeOperation(invoker);</span><br><span class="line">			cacheValue = unwrapReturnValue(returnValue);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Collect any explicit @CachePuts</span></span><br><span class="line">		collectPutRequests(contexts.get(CachePutOperation.class), cacheValue, cachePutRequests);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Process any collected put requests, either from @CachePut or a @Cacheable miss</span></span><br><span class="line">		<span class="keyword">for</span> (CachePutRequest cachePutRequest : cachePutRequests) &#123;</span><br><span class="line">			cachePutRequest.apply(cacheValue);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Process any late evictions</span></span><br><span class="line">		processCacheEvicts(contexts.get(CacheEvictOperation.class), <span class="keyword">false</span>, cacheValue);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> returnValue;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">private</span> Cache.<span class="function">ValueWrapper <span class="title">findCachedItem</span><span class="params">(Collection&lt;CacheOperationContext&gt; contexts)</span> </span>&#123;</span><br><span class="line">		Object result = CacheOperationExpressionEvaluator.NO_RESULT;</span><br><span class="line">		<span class="keyword">for</span> (CacheOperationContext context : contexts) &#123;</span><br><span class="line">			<span class="keyword">if</span> (isConditionPassing(context, result)) &#123;</span><br><span class="line">                <span class="comment">//通过一定规则生成key值(生成规则见generateKey方法)</span></span><br><span class="line">				Object key = generateKey(context, result);</span><br><span class="line">                <span class="comment">//通过生成的key寻找缓存</span></span><br><span class="line">				Cache.ValueWrapper cached = findInCaches(context, key);</span><br><span class="line">				<span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span> cached;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">						logger.trace(<span class="string">&quot;No cache entry for key &#x27;&quot;</span> + key + <span class="string">&quot;&#x27; in cache(s) &quot;</span> + context.getCacheNames());</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//key的生成策略</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">generateKey</span><span class="params">(<span class="meta">@Nullable</span> Object result)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//如果@Cacheable设置了属性key，则根据设置值生成key</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(<span class="keyword">this</span>.metadata.operation.getKey())) &#123;</span><br><span class="line">            EvaluationContext evaluationContext = createEvaluationContext(result);</span><br><span class="line">            <span class="keyword">return</span> evaluator.key(<span class="keyword">this</span>.metadata.operation.getKey(), <span class="keyword">this</span>.metadata.methodKey, evaluationContext);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//否则使用keyGenerator生成key，默认keyGenerator为SimpleKeyGenerator</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.metadata.keyGenerator.generate(<span class="keyword">this</span>.target, <span class="keyword">this</span>.metadata.method, <span class="keyword">this</span>.args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>默认情况下使用SimpleKeyGenerator生成key</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleKeyGenerator</span> <span class="keyword">implements</span> <span class="title">KeyGenerator</span> </span>&#123;</span><br><span class="line">    <span class="comment">//SimpleKeyGenerator的生成规则</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">generateKey</span><span class="params">(Object... params)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//若无参，则返回空key</span></span><br><span class="line">		<span class="keyword">if</span> (params.length == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> SimpleKey.EMPTY;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (params.length == <span class="number">1</span>) &#123;</span><br><span class="line">			Object param = params[<span class="number">0</span>];</span><br><span class="line">			<span class="keyword">if</span> (param != <span class="keyword">null</span> &amp;&amp; !param.getClass().isArray()) &#123;</span><br><span class="line">                <span class="comment">//1个参数，则直接返回该参数</span></span><br><span class="line">				<span class="keyword">return</span> param;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">          <span class="comment">//多个参数返回数组</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SimpleKey(params);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认的缓存类ConcurrentMapCache，使用ConcurrentMap存储k-v</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentMapCache</span> <span class="keyword">extends</span> <span class="title">AbstractValueAdaptingCache</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储key-cacheValue</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Object, Object&gt; store;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//通过key查找cacheValue</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Object <span class="title">lookup</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.store.get(key);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//方法调用完后将结果存入缓存中</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Object key, <span class="meta">@Nullable</span> Object value)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.store.put(key, toStoreValue(value));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="五、Redis与缓存"><a href="#五、Redis与缓存" class="headerlink" title="五、Redis与缓存"></a>五、Redis与缓存</h2><h3 id="1-环境搭建"><a href="#1-环境搭建" class="headerlink" title="1. 环境搭建"></a>1. 环境搭建</h3><p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在spring.properties指定Redis服务器地址</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#redis服务器主机地址</span></span><br><span class="line"><span class="meta">spring.redis.host</span>=<span class="string">192.168.31.162</span></span><br></pre></td></tr></table></figure>



<h3 id="2-RedisTemplate"><a href="#2-RedisTemplate" class="headerlink" title="2. RedisTemplate"></a>2. RedisTemplate</h3><p>RedisAutoConfiguration向容器中导入了两个类RedisTemplate&lt;Object, Object&gt; redisTemplate和StringRedisTemplate，作为Redis客户端分别操作k-v都为对象和k-v都为字符串的值</p>
<p><strong>Redis常见的五大数据类型</strong></p>
<p>String（字符串）、List（列表）、Set（集合）、Hash（散列）、ZSet（有序集合）</p>
<p>​    stringRedisTemplate.opsForValue()[String（字符串）]</p>
<p>​    stringRedisTemplate.opsForList()[List（列表）]</p>
<p>​    stringRedisTemplate.opsForSet()[Set（集合）]</p>
<p>​    stringRedisTemplate.opsForHash()[Hash（散列）]</p>
<p>​    stringRedisTemplate.opsForZSet()[ZSet（有序集合）]</p>
<h3 id="3-Redis缓存使用"><a href="#3-Redis缓存使用" class="headerlink" title="3. Redis缓存使用"></a>3. Redis缓存使用</h3><p>在导入redis依赖后RedisCacheConfiguration类就会自动生效，创建RedisCacheManager，并使用RedisCache进行缓存数据，要缓存的对象的类要实现Serializable接口，默认情况下是以<strong>jdk序列化数据</strong>存在redis中，如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">k:&quot;emp::1&quot;</span><br><span class="line">v:</span><br><span class="line">\xAC\xED\x00\x05sr\x00$cn.edu.ustc.springboot.bean.Employeeuqf\x03p\x9A\xCF\xE0\x02\x00\x05L\x00\x03dIdt\x00\x13Ljava/lang/Integer;L\x00\x05emailt\x00\x12Ljava/lang/String;L\x00\x06genderq\x00~\x00\x01L\x00\x02idq\x00~\x00\x01L\x00\x08lastNameq\x00~\x00\x02xpsr\x00\x11java.lang.Integer\x12\xE2\xA0\xA4\xF7\x81\x878\x02\x00\x01I\x00\x05valuexr\x00\x10java.lang.Number\x86\xAC\x95\x1D\x0B\x94\xE0\x8B\x02\x00\x00xp\x00\x00\x00\x03t\x00\x07cch@aaasq\x00~\x00\x04\x00\x00\x00\x01q\x00~\x00\x08t\x00\x03cch</span><br></pre></td></tr></table></figure>

<p>要想让对象以<strong>json形式</strong>存储在redis中，需要自定义RedisCacheConfiguration，使用GenericJackson2JsonRedisSerializer类对value进行序列化，并且如果要使配置文件中的配置生效，还要在RedisCacheConfiguration设置各项参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRedisConfig</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> org.springframework.data.redis.cache.<span class="function">RedisCacheConfiguration <span class="title">redisCacheConfiguration</span><span class="params">(CacheProperties cacheProperties)</span> </span>&#123;</span><br><span class="line">        CacheProperties.Redis redisProperties = cacheProperties.getRedis();</span><br><span class="line">        org.springframework.data.redis.cache.RedisCacheConfiguration config = org.springframework.data.redis.cache.RedisCacheConfiguration</span><br><span class="line">                .defaultCacheConfig();</span><br><span class="line">        <span class="comment">//设置json为序列化器</span></span><br><span class="line">        config = config.serializeValuesWith(</span><br><span class="line">                RedisSerializationContext.SerializationPair.fromSerializer(<span class="keyword">new</span> GenericJackson2JsonRedisSerializer()));</span><br><span class="line">        <span class="comment">//设置配置文件中的各项参数</span></span><br><span class="line">        <span class="keyword">if</span> (redisProperties.getTimeToLive() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            config = config.entryTtl(redisProperties.getTimeToLive());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (redisProperties.getKeyPrefix() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            config = config.prefixKeysWith(redisProperties.getKeyPrefix());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!redisProperties.isCacheNullValues()) &#123;</span><br><span class="line">            config = config.disableCachingNullValues();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!redisProperties.isUseKeyPrefix()) &#123;</span><br><span class="line">            config = config.disableKeyPrefix();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>序列化数据如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">k:&quot;emp::3&quot;</span><br><span class="line"></span><br><span class="line">v:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;@class&quot;</span>: <span class="string">&quot;cn.edu.ustc.springboot.bean.Employee&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;id&quot;</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">&quot;lastName&quot;</span>: <span class="string">&quot;aaa&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;aaaa&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;gender&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;dId&quot;</span>: <span class="number">5</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>，这里必须用<strong>GenericJackson2JsonRedisSerializer</strong>进行value的序列化解析，如果使用Jackson2JsonRedisSerializer，序列化的json没有<code> &quot;@class&quot;: &quot;cn.edu.ustc.springboot.bean.Employee&quot;</code>,在读取缓存时会报类型转换异常。</p>
<h3 id="4-Redis缓存原理"><a href="#4-Redis缓存原理" class="headerlink" title="4. Redis缓存原理"></a>4. Redis缓存原理</h3><p>配置类RedisCacheConfiguration向容器中导入了其定制的RedisCacheManager，在默认的RedisCacheManager的配置中，是使用jdk序列化value值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(RedisConnectionFactory.class)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(RedisAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(RedisConnectionFactory.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(CacheManager.class)</span></span><br><span class="line"><span class="meta">@Conditional(CacheCondition.class)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisCacheConfiguration</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//向容器中导入RedisCacheManager</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function">RedisCacheManager <span class="title">cacheManager</span><span class="params">(CacheProperties cacheProperties, CacheManagerCustomizers cacheManagerCustomizers,</span></span></span><br><span class="line"><span class="function"><span class="params">			ObjectProvider&lt;org.springframework.data.redis.cache.RedisCacheConfiguration&gt; redisCacheConfiguration,</span></span></span><br><span class="line"><span class="function"><span class="params">			ObjectProvider&lt;RedisCacheManagerBuilderCustomizer&gt; redisCacheManagerBuilderCustomizers,</span></span></span><br><span class="line"><span class="function"><span class="params">			RedisConnectionFactory redisConnectionFactory, ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//使用determineConfiguration()的返回值生成RedisCacheManagerBuilder</span></span><br><span class="line">        <span class="comment">//调用了RedisCacheManagerBuilder的cacheDefaults()方法(见下一代码块)</span></span><br><span class="line">        RedisCacheManagerBuilder builder = RedisCacheManager.builder(redisConnectionFactory).cacheDefaults(</span><br><span class="line">				determineConfiguration(cacheProperties, redisCacheConfiguration, resourceLoader.getClassLoader()));</span><br><span class="line">		List&lt;String&gt; cacheNames = cacheProperties.getCacheNames();</span><br><span class="line">		<span class="keyword">if</span> (!cacheNames.isEmpty()) &#123;</span><br><span class="line">			builder.initialCacheNames(<span class="keyword">new</span> LinkedHashSet&lt;&gt;(cacheNames));</span><br><span class="line">		&#125;</span><br><span class="line">		redisCacheManagerBuilderCustomizers.orderedStream().forEach((customizer) -&gt; customizer.customize(builder));</span><br><span class="line">        <span class="comment">//使用RedisCacheManagerBuilder的build()方法创建RedisCacheManager并进行定制操作</span></span><br><span class="line">		<span class="keyword">return</span> cacheManagerCustomizers.customize(builder.build());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">private</span> org.springframework.data.redis.cache.<span class="function">RedisCacheConfiguration <span class="title">determineConfiguration</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">			CacheProperties cacheProperties,</span></span></span><br><span class="line"><span class="function"><span class="params">			ObjectProvider&lt;org.springframework.data.redis.cache.RedisCacheConfiguration&gt; redisCacheConfiguration,</span></span></span><br><span class="line"><span class="function"><span class="params">			ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//如果容器中存在RedisCacheConfiguration就直接返回，否则调用RedisCacheConfiguration()创建</span></span><br><span class="line">		<span class="keyword">return</span> redisCacheConfiguration.getIfAvailable(() -&gt; createConfiguration(cacheProperties, classLoader));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//createConfiguration()定义了其序列化value的规则</span></span><br><span class="line">	<span class="keyword">private</span> org.springframework.data.redis.cache.<span class="function">RedisCacheConfiguration <span class="title">createConfiguration</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">			CacheProperties cacheProperties, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">		Redis redisProperties = cacheProperties.getRedis();</span><br><span class="line">		org.springframework.data.redis.cache.RedisCacheConfiguration config = org.springframework.data.redis.cache.RedisCacheConfiguration</span><br><span class="line">				.defaultCacheConfig();</span><br><span class="line">        <span class="comment">//使用jdk序列化器对value进行序列化</span></span><br><span class="line">		config = config.serializeValuesWith(</span><br><span class="line">				SerializationPair.fromSerializer(<span class="keyword">new</span> JdkSerializationRedisSerializer(classLoader)));</span><br><span class="line">        <span class="comment">//设置properties文件中设置的各项属性</span></span><br><span class="line">		<span class="keyword">if</span> (redisProperties.getTimeToLive() != <span class="keyword">null</span>) &#123;</span><br><span class="line">			config = config.entryTtl(redisProperties.getTimeToLive());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (redisProperties.getKeyPrefix() != <span class="keyword">null</span>) &#123;</span><br><span class="line">			config = config.prefixKeysWith(redisProperties.getKeyPrefix());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!redisProperties.isCacheNullValues()) &#123;</span><br><span class="line">			config = config.disableCachingNullValues();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!redisProperties.isUseKeyPrefix()) &#123;</span><br><span class="line">			config = config.disableKeyPrefix();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> config;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RedisCacheManager的直接构造类，该类保存了配置类RedisCacheConfiguration，该配置在会传递给RedisCacheManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisCacheManagerBuilder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> RedisCacheWriter cacheWriter;</span><br><span class="line">    	<span class="comment">//默认缓存配置使用RedisCacheConfiguration的默认配置</span></span><br><span class="line">    	<span class="comment">//该默认配置缓存时默认将k按字符串存储，v按jdk序列化数据存储(见下一代码块)</span></span><br><span class="line">		<span class="keyword">private</span> RedisCacheConfiguration defaultCacheConfiguration = RedisCacheConfiguration.defaultCacheConfig();</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, RedisCacheConfiguration&gt; initialCaches = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">boolean</span> enableTransactions;</span><br><span class="line">		<span class="keyword">boolean</span> allowInFlightCacheCreation = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="title">RedisCacheManagerBuilder</span><span class="params">(RedisCacheWriter cacheWriter)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">this</span>.cacheWriter = cacheWriter;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">    	<span class="comment">//传入RedisCacheManagerBuilder使用的缓存配置规则RedisCacheConfiguration类</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> RedisCacheManagerBuilder <span class="title">cacheDefaults</span><span class="params">(RedisCacheConfiguration defaultCacheConfiguration)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">			Assert.notNull(defaultCacheConfiguration, <span class="string">&quot;DefaultCacheConfiguration must not be null!&quot;</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">this</span>.defaultCacheConfiguration = defaultCacheConfiguration;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">		&#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//使用默认defaultCacheConfiguration创建RedisCacheManager</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisCacheManager <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">			RedisCacheManager cm = <span class="keyword">new</span> RedisCacheManager(cacheWriter, defaultCacheConfiguration, initialCaches,</span><br><span class="line">					allowInFlightCacheCreation);</span><br><span class="line"></span><br><span class="line">			cm.setTransactionAware(enableTransactions);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> cm;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>RedisCacheConfiguration保存了许多缓存规则，这些规则都保存在RedisCacheManagerBuilder的RedisCacheConfiguration defaultCacheConfiguration属性中，并且当RedisCacheManagerBuilder创建RedisCacheManager传递过去</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisCacheConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Duration ttl;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> cacheNullValues;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> CacheKeyPrefix keyPrefix;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> usePrefix;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> SerializationPair&lt;String&gt; keySerializationPair;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> SerializationPair&lt;Object&gt; valueSerializationPair;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ConversionService conversionService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//默认缓存配置</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RedisCacheConfiguration <span class="title">defaultCacheConfig</span><span class="params">(<span class="meta">@Nullable</span> ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            DefaultFormattingConversionService conversionService = <span class="keyword">new</span> DefaultFormattingConversionService();</span><br><span class="line"></span><br><span class="line">            registerDefaultConverters(conversionService);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RedisCacheConfiguration(Duration.ZERO, <span class="keyword">true</span>, <span class="keyword">true</span>, CacheKeyPrefix.simple(),</span><br><span class="line">                                     SerializationPair.fromSerializer(RedisSerializer.string()),<span class="comment">//key使用字符串</span></span><br><span class="line">                                               SerializationPair.fromSerializer(RedisSerializer.java(classLoader)), conversionService);</span><br><span class="line">        <span class="comment">//value按jdk序列化存储</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>RedisCacheManager在创建RedisCache时将RedisCacheConfiguration传递过去，并在创建RedisCache时通过createRedisCache()起作用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisCacheManager</span> <span class="keyword">extends</span> <span class="title">AbstractTransactionSupportingCacheManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> RedisCacheWriter cacheWriter;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> RedisCacheConfiguration defaultCacheConfig;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, RedisCacheConfiguration&gt; initialCacheConfiguration;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> allowInFlightCacheCreation;</span><br><span class="line">    </span><br><span class="line">    	<span class="function"><span class="keyword">protected</span> RedisCache <span class="title">createRedisCache</span><span class="params">(String name, <span class="meta">@Nullable</span> RedisCacheConfiguration cacheConfig)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//如果调用该方法时RedisCacheConfiguration有值则使用定制的，否则则使用默认的RedisCacheConfiguration defaultCacheConfig，即RedisCacheManagerBuilder传递过来的配置</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> RedisCache(name, cacheWriter, cacheConfig != <span class="keyword">null</span> ? cacheConfig : defaultCacheConfig);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>RedisCache，Redis缓存，具体负责将缓存数据序列化的地方，将RedisCacheConfiguration的序列化对SerializationPair提取出来并使用其定义的序列化方式分别对k和v进行序列化操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisCache</span> <span class="keyword">extends</span> <span class="title">AbstractValueAdaptingCache</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] BINARY_NULL_VALUE = RedisSerializer.java().serialize(NullValue.INSTANCE);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> RedisCacheWriter cacheWriter;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> RedisCacheConfiguration cacheConfig;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ConversionService conversionService;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Object key, <span class="meta">@Nullable</span> Object value)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		Object cacheValue = preProcessCacheValue(value);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!isAllowNullValues() &amp;&amp; cacheValue == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(</span><br><span class="line">					<span class="string">&quot;Cache &#x27;%s&#x27; does not allow &#x27;null&#x27; values. Avoid storing null via &#x27;@Cacheable(unless=\&quot;#result == null\&quot;)&#x27; or configure RedisCache to allow &#x27;null&#x27; via RedisCacheConfiguration.&quot;</span>,</span><br><span class="line">					name));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//在put k-v时使用cacheConfig中的k-v序列化器分别对k-v进行序列化</span></span><br><span class="line">		cacheWriter.put(name, createAndConvertCacheKey(key), serializeCacheValue(cacheValue), cacheConfig.getTtl());</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//从cacheConfig(即RedisCacheConfiguration)中获取KeySerializationPair并写入key值</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">byte</span>[] serializeCacheKey(String cacheKey) &#123;</span><br><span class="line">		<span class="keyword">return</span> ByteUtils.getBytes(cacheConfig.getKeySerializationPair().write(cacheKey));</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//从cacheConfig(即RedisCacheConfiguration)中获取ValueSerializationPair并写入key值</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">byte</span>[] serializeCacheValue(Object value) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isAllowNullValues() &amp;&amp; value <span class="keyword">instanceof</span> NullValue) &#123;</span><br><span class="line">            <span class="keyword">return</span> BINARY_NULL_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ByteUtils.getBytes(cacheConfig.getValueSerializationPair().write(value));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>分析到这也就不难理解，要使用json保存序列化数据时，需要自定义RedisCacheConfiguration，在RedisCacheConfiguration中定义序列化转化规则，并向RedisCacheManager传入我们自己定制的RedisCacheConfiguration了，我定制的序列化规则会跟随RedisCacheConfiguration一直传递到RedisCache，并在序列化时发挥作用。</p>
<h1 id="二-Spring-Boot与消息"><a href="#二-Spring-Boot与消息" class="headerlink" title="(二) Spring Boot与消息"></a>(二) Spring Boot与消息</h1><h2 id="一、消息简介"><a href="#一、消息简介" class="headerlink" title="一、消息简介"></a>一、消息简介</h2><p><strong>消息代理规范</strong></p>
<ul>
<li>JMS（Java Message Service）JAVA消息服务<ul>
<li>基于JVM消息代理的规范。ActiveMQ、HornetMQ是JMS实现</li>
</ul>
</li>
<li>AMQP（Advanced Message Queuing Protocol）<ul>
<li>高级消息队列协议，也是一个消息代理的规范，兼容JMS</li>
<li>RabbitMQ是AMQP的实现</li>
</ul>
</li>
</ul>
<p><strong>作用</strong></p>
<p>通过消息服务中间件来提升系统异步通信、扩展解耦能力</p>
<p>当消息发送者发送消息以后，将由消息代理接管，消息代理保证消息传递到指定目的地</p>
<p><strong>应用场景</strong></p>
<ol>
<li>异步处理</li>
</ol>
<p>​    用户注册操作和消息处理并行，提高响应速度</p>
<img src="https://i.loli.net/2020/10/03/nbJN45z6D3uEs97.png" style="zoom:50%;">

<ol start="2">
<li><p>应用解耦</p>
<p>在下单时库存系统不能正常使用。也不影响正常下单，因为下单后，订单系统写入消息队列就不再关心其他的后续操作了。实现订单系统与库存系统的应用解耦</p>
<img src="https://i.loli.net/2020/10/03/HMk4oKfBCsjm2cY.png" style="zoom:60%;">
</li>
<li><p>流量削峰</p>
<p>用户的请求，服务器接收后，首先写入消息队列。假如消息队列长度超过最大数量，则直接抛弃用户请求或跳转到错误页面</p>
<p>秒杀业务根据消息队列中的请求信息，再做后续处理</p>
<p><img src="https://i.loli.net/2020/10/03/qWTQo5azcxihAVU.png"></p>
</li>
</ol>
<h2 id="二、RabbitMQ"><a href="#二、RabbitMQ" class="headerlink" title="二、RabbitMQ"></a>二、RabbitMQ</h2><p>RabbitMQ是一个由erlang开发的AMQP(Advanved Message Queue Protocol)的开源实现。</p>
<h3 id="1-核心概念"><a href="#1-核心概念" class="headerlink" title="1. 核心概念"></a>1. 核心概念</h3><ul>
<li><p><strong>Message</strong></p>
<ul>
<li>消息，消息是不具名的，它由消息头和消息体组成</li>
<li>消息头，包括routing-key（路由键）、priority（相对于其他消息的优先权）、delivery-mode（指出该消息可能需要持久性存储）等</li>
</ul>
</li>
<li><p>Publisher</p>
<ul>
<li>消息的生产者，也是一个向交换器发布消息的客户端应用程序</li>
</ul>
</li>
<li><p><strong>Exchange</strong></p>
<ul>
<li>交换器，将生产者消息路由给服务器中的队列</li>
<li>类型有direct(默认)，fanout, topic, 和headers，具有不同转发策略</li>
</ul>
</li>
<li><p><strong>Queue</strong></p>
<ul>
<li>消息队列，保存消息直到发送给消费者</li>
</ul>
</li>
<li><p><strong>Binding</strong></p>
<ul>
<li>绑定，用于消息队列和交换器之间的关联</li>
</ul>
</li>
<li><p>Connection</p>
<ul>
<li>网络连接，比如一个TCP连接</li>
</ul>
</li>
<li><p>Consumer</p>
<ul>
<li>消息的消费者，表示一个从消息队列中取得消息的客户端应用程序</li>
</ul>
</li>
<li><p>Virtual Host</p>
<ul>
<li>虚拟主机，表示一批交换器、消息队列和相关对象。</li>
<li>vhost 是 AMQP 概念的基础，必须在连接时指定</li>
<li>RabbitMQ 默认的 vhost 是 / </li>
</ul>
</li>
<li><p>Broker</p>
<ul>
<li>消息队列服务器实体</li>
</ul>
</li>
</ul>
<h3 id="2-运行机制"><a href="#2-运行机制" class="headerlink" title="2. 运行机制"></a>2. 运行机制</h3><p><strong>消息路由</strong></p>
<p>AMQP 中增加了Exchange 和 Binding 的角色， Binding 决定交换器的消息应该发送到那个队列</p>
<p><strong>Exchange 类型</strong></p>
<ol>
<li><p>direct</p>
<p>点对点模式，消息中的路由键（routing key）如果和 Binding 中的 binding<br>key 一致， 交换器就将消息发到对应的队列中。</p>
</li>
<li><p>fanout</p>
<p>广播模式，每个发到 fanout 类型交换器的消息都会分到所有绑定的队列上去</p>
</li>
<li><p>topic</p>
<p>将路由键和某个模式进行匹配，此时队列需要绑定到一个模式上。它将路由键和绑定键的字符串切分成单词，这些单词之间用点隔开。<br>识别通配符： # 匹配 0 个或多个单词， *匹配一个单词</p>
<p><img src="https://i.loli.net/2020/10/03/xvz4jRmI1hc2QGw.png"></p>
</li>
</ol>
<h2 id="三、-Springboot中的RabbitMQ"><a href="#三、-Springboot中的RabbitMQ" class="headerlink" title="三、 Springboot中的RabbitMQ"></a>三、 Springboot中的RabbitMQ</h2><h3 id="1-环境准备"><a href="#1-环境准备" class="headerlink" title="1. 环境准备"></a>1. 环境准备</h3><p>在docker中安装rabbitmq并运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 5672为服务端口，15672为web控制台端口</span></span><br><span class="line">docker run -d -p 5672:5672 -p 15672:15672 38e57f281891</span><br></pre></td></tr></table></figure>

<p>如果要修改账号密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1、进入docker 的 RabbitMQ 容器中</span><br><span class="line">docker exec -it rabbitmq01 bash</span><br><span class="line"></span><br><span class="line">2、查看用户</span><br><span class="line">rabbitmqctl list_users</span><br><span class="line"></span><br><span class="line">3、修改密码</span><br><span class="line">rabbitmqctl change_password userName newPassword</span><br><span class="line"></span><br><span class="line">4、如果不想要guest的账号也可以新增账号</span><br><span class="line"> rabbitmqctl add_user userName newPassword</span><br><span class="line"> </span><br><span class="line">5、看guest不爽，你还可以delete它</span><br><span class="line">rabbitmqctl delete_user guest</span><br><span class="line"></span><br><span class="line">6、最后别忘了给自己添加的账号增加超级管理员权限</span><br><span class="line">rabbitmqctl set_user_tags userName administrator</span><br></pre></td></tr></table></figure>

<p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--自定义消息转化器Jackson2JsonMessageConverter所需依赖--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定rebbitmq服务器主机</span></span><br><span class="line"><span class="meta">spring.rabbitmq.host</span>=<span class="string">192.168.31.162</span></span><br><span class="line"><span class="comment">#spring.rabbitmq.username=guest  默认值为guest</span></span><br><span class="line"><span class="comment">#spring.rabbitmq.password=guest	 默认值为guest</span></span><br></pre></td></tr></table></figure>

<h3 id="2-RabbitMQ客户端API"><a href="#2-RabbitMQ客户端API" class="headerlink" title="2. RabbitMQ客户端API"></a>2. RabbitMQ客户端API</h3><p>RabbitAutoConfiguration中有内部类RabbitTemplateConfiguration,在该类中向容器中分别导入了<strong>RabbitTemplate</strong>和<strong>AmqpAdmin</strong></p>
<p>在测试类中分别注入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> AmqpAdmin amqpAdmin;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>RabbitTemplate消息发送处理组件</strong></p>
<p>​    可用来发送和接收消息</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发送消息</span></span><br><span class="line">rabbitTemplate.convertAndSend(<span class="string">&quot;amq.direct&quot;</span>,<span class="string">&quot;ustc&quot;</span>,<span class="string">&quot;aaaa&quot;</span>);</span><br><span class="line">      Book book = <span class="keyword">new</span> Book();</span><br><span class="line">      book.setName(<span class="string">&quot;西游记&quot;</span>);</span><br><span class="line">      book.setPrice(<span class="number">23.2f</span>);</span><br><span class="line"><span class="comment">//Book要实现Serializable接口</span></span><br><span class="line">      rabbitTemplate.convertAndSend(<span class="string">&quot;amq.direct&quot;</span>,<span class="string">&quot;ustc&quot;</span>,book);</span><br><span class="line"></span><br><span class="line"><span class="comment">//接收消息</span></span><br><span class="line">Object o = rabbitTemplate.receiveAndConvert(<span class="string">&quot;ustc&quot;</span>);</span><br><span class="line">      System.out.println(o.getClass());  <span class="comment">//class cn.edu.ustc.springboot.bean.Book</span></span><br><span class="line">      System.out.println(o);			<span class="comment">//Book&#123;name=&#x27;西游记&#x27;, price=23.2&#125;</span></span><br></pre></td></tr></table></figure>

<p>默认的消息转化器是SimpleMessageConverter，对于对象以jdk序列化方式存储，若要以Json方式存储对象，就要自定义消息转换器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AmqpConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MessageConverter <span class="title">messageConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//在容器中导入Json的消息转换器</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Jackson2JsonMessageConverter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>AmqpAdmin管理组件</strong></p>
<p>​    可用于创建和删除exchange、binding和queue</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建Direct类型的Exchange</span></span><br><span class="line">amqpAdmin.declareExchange(<span class="keyword">new</span> DirectExchange(<span class="string">&quot;admin.direct&quot;</span>));</span><br><span class="line"><span class="comment">//创建Queue</span></span><br><span class="line">amqpAdmin.declareQueue(<span class="keyword">new</span> Queue(<span class="string">&quot;admin.test&quot;</span>));</span><br><span class="line"><span class="comment">//将创建的队列与Exchange绑定</span></span><br><span class="line">amqpAdmin.declareBinding(<span class="keyword">new</span> Binding(<span class="string">&quot;admin.test&quot;</span>, Binding.DestinationType.QUEUE,<span class="string">&quot;admin.direct&quot;</span>,<span class="string">&quot;admin.test&quot;</span>,<span class="keyword">null</span>));</span><br></pre></td></tr></table></figure>

<p><strong>消息的监听</strong></p>
<ul>
<li><p>在回调方法上标注@RabbitListener注解，并设置其属性queues，注册监听队列，当该队列收到消息时，标注方法遍会调用</p>
</li>
<li><p>可分别使用Message和保存消息所属对象进行消息接收，若使用Object对象进行消息接收，实际上接收到的也是Message</p>
</li>
<li><p>如果知道接收的消息是何种类型的对象，可在方法参数中直接加上该类型参数，也可接收到</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;admin.test&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive1</span><span class="params">(Book book)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;收到消息：&quot;</span>+book);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;admin.test&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive1</span><span class="params">(Object object)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;收到消息：&quot;</span>+object.getClass());</span><br><span class="line">        <span class="comment">//收到消息：class org.springframework.amqp.core.Message</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;admin.test&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive2</span><span class="params">(Message message)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;收到消息&quot;</span>+message.getHeaders()+<span class="string">&quot;---&quot;</span>+message.getPayload());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;admin.test&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive3</span><span class="params">(Message message,Book book)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;3收到消息：book:&quot;</span>+book.getClass()+<span class="string">&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;message:&quot;</span>+message.getClass());</span><br><span class="line">        <span class="comment">//3收到消息：book:class cn.edu.ustc.springboot.bean.Book</span></span><br><span class="line">		<span class="comment">//message: class org.springframework.amqp.core.Message</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>若消息中含有不同的对象，可以使用<code>@RabbitHandler</code>进行分别接收</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &#123;&quot;admin.test&quot;&#125;)</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive4</span><span class="params">(Book book)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;4收到消息：book:&quot;</span> + book);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive5</span><span class="params">(Student student)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;5收到消息：student:&quot;</span> + student);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-消息的可靠投递"><a href="#3-消息的可靠投递" class="headerlink" title="3.  消息的可靠投递"></a>3.  消息的可靠投递</h3><p>为保证消息不丢失，可靠抵达，可以使用事务消息，但性能下降250倍，为此引入确认机制</p>
<ul>
<li><strong>publisher</strong> confirmCallback 确认模式</li>
<li><strong>publisher</strong> returnCallback 未投递到queue 退回模式(失败时触发回调)</li>
<li><strong>consumer</strong> ack(Acknowledgement)机制</li>
</ul>
<img src="https://i.loli.net/2020/10/03/VIEF9woJaGchQpW.png" style="zoom:38%;">

<h4 id="1-confirmCallback"><a href="#1-confirmCallback" class="headerlink" title="(1) confirmCallback"></a>(1) confirmCallback</h4><img src="https://i.loli.net/2020/10/03/mkn8LVQUiTxphsq.png" style="zoom: 50%;">

<p><code> CorrelationData</code>为消息的唯一标识，在发送消息时进行构建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AmqpConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MessageConverter <span class="title">messageConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Jackson2JsonMessageConverter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span>  <span class="comment">//此类创建完成后调用此方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initRabbitTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="keyword">new</span> RabbitTemplate.ConfirmCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirm</span><span class="params">(CorrelationData correlationData, <span class="keyword">boolean</span> ack, String cause)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;confirm CorrelationData:&quot;</span>+correlationData+<span class="string">&quot;===&gt;ack:&quot;</span>+ack+<span class="string">&quot;====&gt;cause:&quot;</span>+cause);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//confirm CorrelationData:CorrelationData [id=e3812ddd-f9c3-4f11-9510-d130a8d8f4d6]===&gt;ack:true====&gt;cause:null</span></span><br><span class="line"><span class="comment">//confirm CorrelationData:CorrelationData [id=d9560acc-f745-4a62-87cf-b6420d58706d]===&gt;ack:true====&gt;cause:null</span></span><br><span class="line"><span class="comment">//confirm CorrelationData:CorrelationData [id=4cf4a709-62ac-4966-afb9-90ec6c62a35b]===&gt;ack:true====&gt;cause:null</span></span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-ReturnCallback"><a href="#2-ReturnCallback" class="headerlink" title="(2) ReturnCallback"></a>(2) ReturnCallback</h4><img src="https://i.loli.net/2020/10/03/w7ktlPEOAZeUMdQ.png" style="zoom: 50%;">

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启发送端抵达队列的确认</span></span><br><span class="line"><span class="meta">spring.rabbitmq.publisher-returns</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 只要抵达队列，以异步发送优先回调</span></span><br><span class="line"><span class="meta">spring.rabbitmq.template.mandatory</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rabbitTemplate.setReturnCallback(<span class="keyword">new</span> RabbitTemplate.ReturnCallback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnedMessage</span><span class="params">(Message message, <span class="keyword">int</span> replyCode, String replyText, String exchange, String routingKey)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;return callback...message:&quot;</span>+message+<span class="string">&quot;===&gt;replycode:&quot;</span>+replyCode+<span class="string">&quot;===&gt;replyText:&quot;</span>+replyText+<span class="string">&quot;===&gt;exchange:&quot;</span>+exchange+<span class="string">&quot;===&gt;routingKey:&quot;</span>+routingKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">return callback...message:(Body:&#39;&#123;&quot;name&quot;:&quot;水浒传&quot;,&quot;price&quot;:0.0&#125;&#39; MessageProperties [headers&#x3D;&#123;spring_returned_message_correlation&#x3D;8f5d080c-35c8-42db-ac3d-0bf7509906aa, __TypeId__&#x3D;cn.edu.ustc.springboot.bean.Book&#125;, contentType&#x3D;application&#x2F;json, contentEncoding&#x3D;UTF-8, contentLength&#x3D;0, receivedDeliveryMode&#x3D;PERSISTENT, priority&#x3D;0, deliveryTag&#x3D;0])&#x3D;&#x3D;&#x3D;&gt;replycode:312&#x3D;&#x3D;&#x3D;&gt;replyText:NO_ROUTE&#x3D;&#x3D;&#x3D;&gt;exchange:admin.direct&#x3D;&#x3D;&#x3D;&gt;routingKey:admin.test0</span><br><span class="line"></span><br><span class="line">confirm CorrelationData:CorrelationData [id&#x3D;8f5d080c-35c8-42db-ac3d-0bf7509906aa]&#x3D;&#x3D;&#x3D;&gt;ack:true&#x3D;&#x3D;&#x3D;&#x3D;&gt;causenull</span><br><span class="line"></span><br><span class="line">return callback...message:(Body:&#39;&#123;&quot;name&quot;:&quot;mhs&quot;,&quot;age&quot;:1&#125;&#39; MessageProperties [headers&#x3D;&#123;spring_returned_message_correlation&#x3D;2961a45c-19ee-4b94-8281-03e00fbdceea, __TypeId__&#x3D;cn.edu.ustc.springboot.bean.Student&#125;, contentType&#x3D;application&#x2F;json, contentEncoding&#x3D;UTF-8, contentLength&#x3D;0, receivedDeliveryMode&#x3D;PERSISTENT, priority&#x3D;0, deliveryTag&#x3D;0])&#x3D;&#x3D;&#x3D;&gt;replycode:312&#x3D;&#x3D;&#x3D;&gt;replyText:NO_ROUTE&#x3D;&#x3D;&#x3D;&gt;exchange:admin.direct&#x3D;&#x3D;&#x3D;&gt;routingKey:admin.test11</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3-ack"><a href="#3-ack" class="headerlink" title="(3) ack"></a>(3) ack</h4><img src="https://i.loli.net/2020/10/03/zcLPnRNXvq2uHoE.png" style="zoom:38%;">

<p>在默认情况下，消息如果消费到一半，服务器宕机，剩下的消息就会默认全部确认，会造成消息丢失，因此需要引入手动确认模式</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 消费端手动ack消息</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.acknowledge-mode</span>=<span class="string">manual</span></span><br></pre></td></tr></table></figure>

<p>只要没有明确通知服务器ack，消息就不会确认收货，可以通过<code>basicAck()</code>进行确认收货</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitHandler</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive4</span><span class="params">(Book book, Message message,Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;4收到消息：book:&quot;</span> + book);</span><br><span class="line">    <span class="comment">//deliveryTag在通道内按顺序自增</span></span><br><span class="line">    <span class="keyword">long</span> deliveryTag = message.getMessageProperties().getDeliveryTag();</span><br><span class="line">    System.out.println(deliveryTag);</span><br><span class="line">    <span class="comment">//通过deliveryTag进行确认，false表示不批量确认</span></span><br><span class="line">    channel.basicAck(deliveryTag,<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此外还可以使用<code>basicNack()</code>和<code>basicReject()</code>进行拒绝收货</p>
<h1 id="三-Spring-boot与检索"><a href="#三-Spring-boot与检索" class="headerlink" title="(三) Spring boot与检索"></a>(三) Spring boot与检索</h1><h2 id="一、-ElasticSearch入门"><a href="#一、-ElasticSearch入门" class="headerlink" title="一、 ElasticSearch入门"></a>一、 ElasticSearch入门</h2><h3 id="1-ES的简介"><a href="#1-ES的简介" class="headerlink" title="1. ES的简介"></a>1. ES的简介</h3><p><strong>简介</strong></p>
<p>我们的应用经常需要添加检索功能，开源的 ElasticSearch 是目前全文搜索引擎的首选。他可以快速的存储、搜索和分析海量数据。Spring Boot通过整合Spring Data ElasticSearch为我们提供了非常便捷的检索功能支持；<br>Elasticsearch是一个分布式搜索服务，提供Restful API，底层基于Lucene，采用多shard（分片）的方式保证数据安全，并且提供自动resharding的功能，github等大型的站点也是采用了ElasticSearch作为其搜索服务。</p>
<p><strong>概念</strong></p>
<p> 员工文档 的形式存储为例：一个<strong>文档</strong>代表一个<strong>员工数据</strong>。存储数据到ElasticSearch 的行为叫做 <strong>索引</strong> ，但在索引一个文档之前，需要确定将文档存储在哪里。</p>
<p> 一个 ElasticSearch 集群可以包含多个 <strong>索引</strong> ，相应的每个索引可以包含多个 <strong>类型</strong> 。 这些不同的类型存储着多个 文<strong>档</strong> ，每个文档又有 多个 <strong>属性</strong> 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">索引（名词）：</span><br><span class="line"></span><br><span class="line">如前所述，一个 *索引* 类似于传统关系数据库中的一个 *数据库* ，是一个存储关系型文档的地方。 *索引* (*index*) 的复数词为 *indices* 或 *indexes* 。</span><br><span class="line"></span><br><span class="line">索引（动词）：</span><br><span class="line"></span><br><span class="line">*索引一个文档* 就是存储一个文档到一个 *索引* （名词）中以便被检索和查询。这非常类似于 SQL 语句中的 &#96;INSERT&#96; 关键词，除了文档已存在时，新文档会替换旧文档情况之外。</span><br></pre></td></tr></table></figure>

<p>类似关系：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-	索引---数据库</span><br><span class="line">-	类型---表</span><br><span class="line">-	文档---表中的记录</span><br><span class="line">-	属性---列</span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2020/10/03/kDuYetTVZ6arn2z.png" style="zoom:50%;">



<h3 id="2-ES的安装与运行"><a href="#2-ES的安装与运行" class="headerlink" title="2. ES的安装与运行"></a>2. ES的安装与运行</h3><p>与ES交互</p>
<ul>
<li><p>9200端口 </p>
<p>​    RESTful API通过HTTP通信</p>
</li>
<li><p>9300端口</p>
<p>​    Java客户端与ES的原生传输协议和集群交互</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 拉取ES镜像</span></span><br><span class="line">docker pull elasticsearch:7.6.1</span><br><span class="line"><span class="meta">#</span><span class="bash">运行ES</span></span><br><span class="line">docker run -e &quot;discovery.type=single-node&quot; -e ES_JAVA_OPTS=&quot;-Xms256m -Xmx256m&quot; -d -p 9200:9200 -p 9300:9300 --name ES03 41072cdeebc5</span><br></pre></td></tr></table></figure>

<p><code>ES_JAVA_OPTS</code>指定java虚拟机相关参数</p>
<p>​    <code>-Xms256m</code>    初始堆内存大小为256m</p>
<p>​    <code>-Xmx256m</code>    最大堆内存大小为256m</p>
<p><code>discovery.type=single-node</code> 设置为单点启动</p>
<h3 id="3-ES的基础入门"><a href="#3-ES的基础入门" class="headerlink" title="3. ES的基础入门"></a>3. ES的基础入门</h3><p><strong>案例：创建一个员工目录，并支持各类型检索</strong></p>
<p><strong>索引员工文档</strong></p>
<p>对于员工目录，我们将做如下操作：</p>
<ul>
<li>每个员工索引一个文档，文档包含该员工的所有信息。</li>
<li>每个文档都将是 <code>employee</code> <em>类型</em> 。</li>
<li>该类型位于 <em>索引</em> <code>megacorp</code> 内。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;megacorp&#x2F;employee&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;first_name&quot; : &quot;John&quot;,</span><br><span class="line">    &quot;last_name&quot; :  &quot;Smith&quot;,</span><br><span class="line">    &quot;age&quot; :        25,</span><br><span class="line">    &quot;about&quot; :      &quot;I love to go rock climbing&quot;,</span><br><span class="line">    &quot;interests&quot;: [ &quot;sports&quot;, &quot;music&quot; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，路径 <code>/megacorp/employee/1</code> 包含了三部分的信息：</p>
<ul>
<li><p><strong><code>megacorp</code></strong></p>
<p>索引名称</p>
</li>
<li><p><strong><code>employee</code></strong></p>
<p>类型名称</p>
</li>
<li><p><strong><code>1</code></strong></p>
<p>特定雇员的ID</p>
</li>
</ul>
<p>请求体 —— JSON 文档 —— 包含了这位员工的所有详细信息</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;megacorp&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;employee&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;_version&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;result&quot;</span>: <span class="string">&quot;created&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;total&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;_seq_no&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;_primary_term&quot;</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同理，添加更多员工</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;megacorp&#x2F;employee&#x2F;2</span><br><span class="line">&#123;</span><br><span class="line">    &quot;first_name&quot; :  &quot;Jane&quot;,</span><br><span class="line">    &quot;last_name&quot; :   &quot;Smith&quot;,</span><br><span class="line">    &quot;age&quot; :         32,</span><br><span class="line">    &quot;about&quot; :       &quot;I like to collect rock albums&quot;,</span><br><span class="line">    &quot;interests&quot;:  [ &quot;music&quot; ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT &#x2F;megacorp&#x2F;employee&#x2F;3</span><br><span class="line">&#123;</span><br><span class="line">    &quot;first_name&quot; :  &quot;Douglas&quot;,</span><br><span class="line">    &quot;last_name&quot; :   &quot;Fir&quot;,</span><br><span class="line">    &quot;age&quot; :         35,</span><br><span class="line">    &quot;about&quot;:        &quot;I like to build cabinets&quot;,</span><br><span class="line">    &quot;interests&quot;:  [ &quot;forestry&quot; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>检索文档</strong></p>
<p>HTTP <code>GET</code> 请求并指定文档的地址——索引库、类型和ID。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;megacorp&#x2F;employee&#x2F;1</span><br></pre></td></tr></table></figure>

<p>返回数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;megacorp&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;employee&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;_version&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;_seq_no&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;_primary_term&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;found&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;first_name&quot;</span>: <span class="string">&quot;John&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;last_name&quot;</span>: <span class="string">&quot;Smith&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;age&quot;</span>: <span class="number">25</span>,</span><br><span class="line">        <span class="attr">&quot;about&quot;</span>: <span class="string">&quot;I love to go rock climbing&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;interests&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;sports&quot;</span>,</span><br><span class="line">            <span class="string">&quot;music&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将 HTTP 命令由 <code>PUT</code> 改为 <code>GET</code> 可以用来检索文档，同样的，可以使用 <code>DELETE</code> 命令来删除文档，以及使用 <code>HEAD</code> 指令来检查文档是否存在。如果想更新已存在的文档，只需再次 <code>PUT</code> 。</p>
<p><strong>轻量搜索</strong></p>
<p>搜索所有雇员：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;megacorp&#x2F;employee&#x2F;_search</span><br></pre></td></tr></table></figure>

<p>返回数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;took&quot;</span>: <span class="number">46</span>,</span><br><span class="line">    <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;total&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;total&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="number">3</span>,</span><br><span class="line">            <span class="attr">&quot;relation&quot;</span>: <span class="string">&quot;eq&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;max_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;hits&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;megacorp&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;employee&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;first_name&quot;</span>: <span class="string">&quot;John&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;last_name&quot;</span>: <span class="string">&quot;Smith&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;age&quot;</span>: <span class="number">25</span>,</span><br><span class="line">                    <span class="attr">&quot;about&quot;</span>: <span class="string">&quot;I love to go rock climbing&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;interests&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;sports&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;music&quot;</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;megacorp&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;employee&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;first_name&quot;</span>: <span class="string">&quot;Jane&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;last_name&quot;</span>: <span class="string">&quot;Smith&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;age&quot;</span>: <span class="number">32</span>,</span><br><span class="line">                    <span class="attr">&quot;about&quot;</span>: <span class="string">&quot;I like to collect rock albums&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;interests&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;music&quot;</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;megacorp&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;employee&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;3&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;first_name&quot;</span>: <span class="string">&quot;Douglas&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;last_name&quot;</span>: <span class="string">&quot;Fir&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;age&quot;</span>: <span class="number">35</span>,</span><br><span class="line">                    <span class="attr">&quot;about&quot;</span>: <span class="string">&quot;I like to build cabinets&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;interests&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;forestry&quot;</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果包括三个文档，放在数据<code>hits</code>中。</p>
<p>搜索姓氏为 <code>Smith</code> 的雇员</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;megacorp&#x2F;employee&#x2F;_search?q&#x3D;last_name:Smith</span><br></pre></td></tr></table></figure>

<p>在请求路径中使用 <code>_search</code> 端点，并将查询本身赋值给参数 <code>q=</code> 。返回结果给出了所有的 Smith：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;took&quot;</span>: <span class="number">23</span>,</span><br><span class="line">    <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;total&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;total&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;relation&quot;</span>: <span class="string">&quot;eq&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;max_score&quot;</span>: <span class="number">0.4700036</span>,</span><br><span class="line">        <span class="attr">&quot;hits&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;megacorp&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;employee&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">0.4700036</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;first_name&quot;</span>: <span class="string">&quot;John&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;last_name&quot;</span>: <span class="string">&quot;Smith&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;age&quot;</span>: <span class="number">25</span>,</span><br><span class="line">                    <span class="attr">&quot;about&quot;</span>: <span class="string">&quot;I love to go rock climbing&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;interests&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;sports&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;music&quot;</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;megacorp&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;employee&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">0.4700036</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;first_name&quot;</span>: <span class="string">&quot;Jane&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;last_name&quot;</span>: <span class="string">&quot;Smith&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;age&quot;</span>: <span class="number">32</span>,</span><br><span class="line">                    <span class="attr">&quot;about&quot;</span>: <span class="string">&quot;I like to collect rock albums&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;interests&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;music&quot;</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用查询表达式搜索</strong></p>
<p>Query-string 搜索通过命令非常方便地进行临时性的即席搜索 ，但它有自身的局限性。Elasticsearch 提供一个丰富灵活的查询语言叫做 <em>查询表达式</em> ， 它支持构建更加复杂和健壮的查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;megacorp&#x2F;employee&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;match&quot; : &#123;</span><br><span class="line">            &quot;last_name&quot; : &quot;Smith&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回效果与之前一样</p>
<p><strong>更复杂的搜索</strong></p>
<p>同样搜索姓氏为 Smith 的员工，但这次我们只需要年龄大于 30 的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;megacorp&#x2F;employee&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;must&quot;: &#123;</span><br><span class="line">                &quot;match&quot; : &#123;</span><br><span class="line">                    &quot;last_name&quot; : &quot;smith&quot; </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;filter&quot;: &#123;</span><br><span class="line">                &quot;range&quot; : &#123;</span><br><span class="line">                    &quot;age&quot; : &#123; &quot;gt&quot; : 30 &#125; </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>全文搜索</strong></p>
<p>搜索下所有喜欢攀岩（rock climbing）的员工：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;megacorp&#x2F;employee&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;match&quot; : &#123;</span><br><span class="line">            &quot;about&quot; : &quot;rock climbing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;took&quot;</span>: <span class="number">13</span>,</span><br><span class="line">    <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;total&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;total&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;relation&quot;</span>: <span class="string">&quot;eq&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;max_score&quot;</span>: <span class="number">1.4167401</span>,</span><br><span class="line">        <span class="attr">&quot;hits&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;megacorp&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;employee&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">1.4167401</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;first_name&quot;</span>: <span class="string">&quot;John&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;last_name&quot;</span>: <span class="string">&quot;Smith&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;age&quot;</span>: <span class="number">25</span>,</span><br><span class="line">                    <span class="attr">&quot;about&quot;</span>: <span class="string">&quot;I love to go rock climbing&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;interests&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;sports&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;music&quot;</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;megacorp&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;employee&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">0.4589591</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;first_name&quot;</span>: <span class="string">&quot;Jane&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;last_name&quot;</span>: <span class="string">&quot;Smith&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;age&quot;</span>: <span class="number">32</span>,</span><br><span class="line">                    <span class="attr">&quot;about&quot;</span>: <span class="string">&quot;I like to collect rock albums&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;interests&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;music&quot;</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到返回结果还带有相关性得分<code>_score</code></p>
<p><strong>短语搜索</strong></p>
<p><strong>精确匹配</strong>一系列单词或者<em>短语</em> 。 比如， 执行这样一个查询，短语 “rock climbing” 的形式紧挨着的雇员记录。</p>
<p>为此对 <code>match</code> 查询稍作调整，使用一个叫做 <code>match_phrase</code> 的查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;megacorp&#x2F;employee&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;match_phrase&quot; : &#123;</span><br><span class="line">            &quot;about&quot; : &quot;rock climbing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>高亮搜索</strong></p>
<p>每个搜索结果中 <em>高亮</em> 部分文本片段</p>
<p>再次执行前面的查询，并增加一个新的 <code>highlight</code> 参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;megacorp&#x2F;employee&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;match_phrase&quot; : &#123;</span><br><span class="line">            &quot;about&quot; : &quot;rock climbing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;highlight&quot;: &#123;</span><br><span class="line">        &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;about&quot; : &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">		...</span><br><span class="line">    </span><br><span class="line">        &quot;hits&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;megacorp&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;employee&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">1.4167401</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;first_name&quot;</span>: <span class="string">&quot;John&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;last_name&quot;</span>: <span class="string">&quot;Smith&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;age&quot;</span>: <span class="number">25</span>,</span><br><span class="line">                    <span class="attr">&quot;about&quot;</span>: <span class="string">&quot;I love to go rock climbing&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;interests&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;sports&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;music&quot;</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;about&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;I love to go &lt;em&gt;rock&lt;/em&gt; &lt;em&gt;climbing&lt;/em&gt;&quot;</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果中还多了一个叫做 <code>highlight</code> 的部分。这个部分包含了 <code>about</code> 属性匹配的文本片段，并以 HTML 标签 <code>&lt;em&gt;</code> 封装</p>
<h2 id="二、-Springboot整合ElasticSearch"><a href="#二、-Springboot整合ElasticSearch" class="headerlink" title="二、 Springboot整合ElasticSearch"></a>二、 Springboot整合ElasticSearch</h2><h3 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h3><p>SpringBoot默认支持两种技术来和ES交互；</p>
<ul>
<li><p>Jest（默认不生效）</p>
<ul>
<li>需要导入jest的工具包（io.searchbox.client.JestClient）</li>
<li>从springboot 2.2.0以后被弃用</li>
</ul>
</li>
<li><p>SpringData ElasticSearch</p>
<p>版本适配说明</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">Spring Data Elasticsearch</th>
<th align="center">Elasticsearch</th>
</tr>
</thead>
<tbody><tr>
<td align="center">3.2.x</td>
<td align="center">6.8.1</td>
</tr>
<tr>
<td align="center">3.1.x</td>
<td align="center">6.2.2</td>
</tr>
<tr>
<td align="center">3.0.x</td>
<td align="center">5.5.0</td>
</tr>
<tr>
<td align="center">2.1.x</td>
<td align="center">2.4.0</td>
</tr>
<tr>
<td align="center">2.0.x</td>
<td align="center">2.2.0</td>
</tr>
<tr>
<td align="center">1.3.x</td>
<td align="center">1.5.2</td>
</tr>
</tbody></table>
<p>Springboot 2.2.6对应于 Spring Data Elasticsearch 3.2.6，即适配Elasticsearch 6.8.1</p>
<h3 id="2-环境搭建"><a href="#2-环境搭建" class="headerlink" title="2. 环境搭建"></a>2. 环境搭建</h3><p>编写文件对应Javabean，指定索引名和类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Document(indexName = &quot;ustc&quot;,type = &quot;book&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String bookName;</span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBookName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bookName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBookName</span><span class="params">(String bookName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bookName = bookName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAuthor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> author;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAuthor</span><span class="params">(String author)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.author = author;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Book&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, bookName=&#x27;&quot;</span> + bookName + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, author=&#x27;&quot;</span> + author + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-ElasticSearch客户端"><a href="#3-ElasticSearch客户端" class="headerlink" title="3. ElasticSearch客户端"></a>3. ElasticSearch客户端</h3><ul>
<li><p><strong>Transport Client</strong></p>
<p>在ES7中已经被弃用，将在ES8被移除</p>
</li>
<li><p><strong>High Level REST Client</strong></p>
<p>ES的默认客户端</p>
</li>
<li><p><strong>Reactive Client</strong></p>
<p>非官方驱动，基于WebClient</p>
</li>
</ul>
<p>下面以REST客户端为例说明ES的使用</p>
<p><strong>配置主机地址</strong></p>
<p>方式一 配置类配置</p>
<p>注意：这种方式底层依赖于Http相关类，因此要导入web相关jar包</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function">RestHighLevelClient <span class="title">client</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ClientConfiguration clientConfiguration = ClientConfiguration.builder() </span><br><span class="line">      .connectedTo(<span class="string">&quot;localhost:9200&quot;</span>)</span><br><span class="line">      .build();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RestClients.create(clientConfiguration).rest();                  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方式二 spring配置文件指定</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.elasticsearch.rest.uris</span>=<span class="string">http://192.168.31.162:9200</span></span><br></pre></td></tr></table></figure>

<p><strong>在测试类中注入客户端</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RestHighLevelClient highLevelClient;</span><br></pre></td></tr></table></figure>

<p><strong>创建索引</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IndexRequest request = <span class="keyword">new</span> IndexRequest(<span class="string">&quot;ustc&quot;</span>, <span class="string">&quot;book&quot;</span>,</span><br><span class="line">        UUID.randomUUID().toString())</span><br><span class="line">        .source(Collections.singletonMap(<span class="string">&quot;feature&quot;</span>, <span class="string">&quot;high-level-rest-client&quot;</span>))</span><br><span class="line">        .setRefreshPolicy(WriteRequest.RefreshPolicy.IMMEDIATE);</span><br><span class="line">IndexResponse index = highLevelClient.index(request, RequestOptions.DEFAULT);</span><br><span class="line">System.out.println(index.toString());</span><br></pre></td></tr></table></figure>

<p>下面为创建索引</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;ustc&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;book&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;0dc9f47a-7913-481d-a36d-e8f034a6a3ac&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;feature&quot;</span>: <span class="string">&quot;high-level-rest-client&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到索引</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//分别指定要获取的索引、类型、id</span></span><br><span class="line">GetRequest getRequest = <span class="keyword">new</span> GetRequest(<span class="string">&quot;ustc&quot;</span>,<span class="string">&quot;book&quot;</span>,<span class="string">&quot;0dc9f47a-7913-481d-a36d-e8f034a6a3ac&quot;</span>);</span><br><span class="line">GetResponse documentFields = highLevelClient.get(getRequest, RequestOptions.DEFAULT);</span><br><span class="line">System.out.println(documentFields);</span><br></pre></td></tr></table></figure>



<h3 id="4-ElasticsearchRestTemplate"><a href="#4-ElasticsearchRestTemplate" class="headerlink" title="4. ElasticsearchRestTemplate"></a>4. ElasticsearchRestTemplate</h3><p>ES有两个模板，分别为<code>ElasticsearchRestTemplate</code>和<code>ElasticsearchTemplate</code></p>
<p>分别对应于<strong>High Level REST Client</strong>和<strong>Transport Client</strong>(弃用)，两个模板都实现了<code>ElasticsearchOperations</code>接口，因此使用时我们一般使用<code>ElasticsearchOperations</code>，具体实现方式由底层决定。</p>
<p>由于在<code>AbstractElasticsearchConfiguration</code>中已经向容器中导入了<code>ElasticsearchRestTemplate</code>，因此我们使用时可以直接注入</p>
<p><strong>注入模板</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">ElasticsearchOperations elasticsearchOperations;</span><br></pre></td></tr></table></figure>

<p><strong>保存索引</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Book book = <span class="keyword">new</span> Book();</span><br><span class="line">book.setAuthor(<span class="string">&quot;路遥&quot;</span>);</span><br><span class="line">book.setBookName(<span class="string">&quot;平凡的世界&quot;</span>);</span><br><span class="line">book.setId(<span class="number">1</span>);</span><br><span class="line">IndexQuery indexQuery = <span class="keyword">new</span> IndexQueryBuilder()</span><br><span class="line">    .withId(book.getId().toString())</span><br><span class="line">    .withObject(book)</span><br><span class="line">    .build();</span><br><span class="line">String index = elasticsearchOperations.index(indexQuery);</span><br></pre></td></tr></table></figure>

<p><strong>查询索引</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Book book = elasticsearchOperations.queryForObject(GetQuery.getById(<span class="string">&quot;1&quot;</span>), Book.class);</span><br></pre></td></tr></table></figure>



<h3 id="5-Elasticsearch-Repositories"><a href="#5-Elasticsearch-Repositories" class="headerlink" title="5. Elasticsearch Repositories"></a>5. Elasticsearch Repositories</h3><p>编写相关Repository并继承Repository或ElasticsearchRepository，泛型分别为&lt;查询类，主键&gt;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BookRepository</span> <span class="keyword">extends</span> <span class="title">Repository</span>&lt;<span class="title">Book</span>,<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">List&lt;Book&gt; <span class="title">findByBookNameAndAuthor</span><span class="params">(String bookName, String author)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询的方法仅需按照<strong>一定规则</strong>命名即可实现功能，<strong>无需编写实现</strong>，如上findByBookNameAndAuthor()方法相当于ES的json查询</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;bool&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;must&quot;</span> : [</span><br><span class="line">                &#123; <span class="attr">&quot;query_string&quot;</span> : &#123; <span class="attr">&quot;query&quot;</span> : <span class="string">&quot;?&quot;</span>, <span class="attr">&quot;fields&quot;</span> : [ <span class="string">&quot;bookName&quot;</span> ] &#125; &#125;,</span><br><span class="line">                &#123; <span class="attr">&quot;query_string&quot;</span> : &#123; <span class="attr">&quot;query&quot;</span> : <span class="string">&quot;?&quot;</span>, <span class="attr">&quot;fields&quot;</span> : [ <span class="string">&quot;author&quot;</span> ] &#125; &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-data/elasticsearch/docs/3.2.6.RELEASE/reference/html/#elasticsearch.repositories">更多命名规则见本文档</a></p>
<p><strong>@Query</strong></p>
<p>此外，还可以使用<code>@Query</code>自定义请求json</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">BookRepository</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">Book</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Query(&quot;&#123;\&quot;match\&quot;: &#123;\&quot;name\&quot;: &#123;\&quot;query\&quot;: \&quot;?0\&quot;&#125;&#125;&#125;&quot;)</span></span><br><span class="line">    <span class="function">Page&lt;Book&gt; <span class="title">findByName</span><span class="params">(String name,Pageable pageable)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若参数为John，相当于请求体为</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;John&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>更多ES与springboot整合内容见<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-data/elasticsearch/docs/3.2.6.RELEASE/reference/html/#new-features">官方文档</a></strong></p>
<h1 id="四-Spring-boot与任务"><a href="#四-Spring-boot与任务" class="headerlink" title="(四) Spring boot与任务"></a>(四) Spring boot与任务</h1><h2 id="一、异步任务"><a href="#一、异步任务" class="headerlink" title="一、异步任务"></a>一、异步任务</h2><p>在Java应用中，绝大多数情况下都是通过同步的方式来实现交互处理的；但是在处理与第三方系统交互的时候，容易造成响应迟缓的情况，之前大部分都是使用多线程来完成此类任务，springboot中可以用异步任务解决。</p>
<p><strong>两个注解：</strong></p>
<p><code>@Async</code>    在需要异步执行的方法上标注注解</p>
<p><code>@EnableAsync</code>    在主类上标注开启异步任务支持</p>
<p>开启异步任务后，当controller层调用该方法会直接返回结果，该任务异步执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;hello async task!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="二、-定时任务"><a href="#二、-定时任务" class="headerlink" title="二、 定时任务"></a>二、 定时任务</h2><p>项目开发中经常需要执行一些定时任务，比如需要在每天凌晨时候，分析一次前一天的日志信息。Spring为我们提供了异步执行任务调度的方式，提供TaskExecutor 、TaskScheduler 接口。</p>
<p><strong>两个注解：</strong></p>
<p><code>@EnableScheduling</code> 标注在主类，开启对定时任务支持</p>
<p><code>@Scheduled </code> 标注在执行的方法上，并制定cron属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduleService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0,1,2,3,4,5,30,50 * * * * 0-7&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">schedule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;I am executing..&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>cron</strong>表达式：</p>
<p> second(秒), minute（分）, hour（时）, day of month（日）, month（月）, day of week（周几）.</p>
<p><code>0 0/5 14,18 * * ?</code>     每天14点整，和18点整，每隔5分钟执行一次</p>
<p><code>  0 15 10 ? * 1-6</code>         每个月的周一至周六10:15分执行一次</p>
<p><code>0 0 2 ? * 6L</code>                每个月的最后一个周六凌晨2点执行一次</p>
<p><code>0 0 2 LW * ?</code>                每个月的最后一个工作日凌晨2点执行一次</p>
<p><code>0 0 2-4 ? * 1#1</code>          每个月的第一个周一凌晨2点到4点期间，每个整点都执行一次；</p>
<table>
<thead>
<tr>
<th><strong>字段</strong></th>
<th><strong>允许值</strong></th>
<th><strong>允许的特殊字符</strong></th>
</tr>
</thead>
<tbody><tr>
<td>秒</td>
<td>0-59</td>
<td>, -  * /</td>
</tr>
<tr>
<td>分</td>
<td>0-59</td>
<td>, -  * /</td>
</tr>
<tr>
<td>小时</td>
<td>0-23</td>
<td>, -  * /</td>
</tr>
<tr>
<td>日期</td>
<td>1-31</td>
<td>, -  * ? / L W C</td>
</tr>
<tr>
<td>月份</td>
<td>1-12</td>
<td>, -  * /</td>
</tr>
<tr>
<td>星期</td>
<td>0-7或SUN-SAT  0,7是SUN</td>
<td>, -  * ? / L C #</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th><strong>特殊字符</strong></th>
<th><strong>代表含义</strong></th>
</tr>
</thead>
<tbody><tr>
<td>,</td>
<td>枚举</td>
</tr>
<tr>
<td>-</td>
<td>区间</td>
</tr>
<tr>
<td>*</td>
<td>任意</td>
</tr>
<tr>
<td>/</td>
<td>步长</td>
</tr>
<tr>
<td>?</td>
<td>日/星期冲突匹配</td>
</tr>
<tr>
<td>L</td>
<td>最后</td>
</tr>
<tr>
<td>W</td>
<td>工作日</td>
</tr>
<tr>
<td>C</td>
<td>和calendar联系后计算过的值</td>
</tr>
<tr>
<td>#</td>
<td>星期，4#2，第2个星期四</td>
</tr>
</tbody></table>
<h2 id="三、-邮件任务"><a href="#三、-邮件任务" class="headerlink" title="三、 邮件任务"></a>三、 邮件任务</h2><p>springboot自动配置包中<code>MailSenderAutoConfiguration</code>通过<code>@Import</code>注解向容器中导入了<code>MailSenderJndiConfiguration</code>,而<code>MailSenderJndiConfiguration</code>向容器中导入了<code>JavaMailSenderImpl</code>类，我们可以使用该类发送邮件</p>
<p><strong>配置文件</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.mail.username</span>=<span class="string">邮箱用户名</span></span><br><span class="line"><span class="meta">spring.mail.password</span>=<span class="string">邮箱密码或授权码</span></span><br><span class="line"><span class="meta">spring.mail.host</span>=<span class="string">smtp.example.com </span></span><br></pre></td></tr></table></figure>

<p><strong>自动注入</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> JavaMailSenderImpl javaMailSender;</span><br></pre></td></tr></table></figure>

<p><strong>简单邮件发送</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SimpleMailMessage message = <span class="keyword">new</span> SimpleMailMessage();</span><br><span class="line"><span class="comment">//设置主题和内容</span></span><br><span class="line">message.setSubject(<span class="string">&quot;今天开会&quot;</span>);</span><br><span class="line">message.setText(<span class="string">&quot;物质楼555开会，不要迟到&quot;</span>);</span><br><span class="line"><span class="comment">//设置发送方和接收方</span></span><br><span class="line">message.setFrom(<span class="string">&quot;xxx@163.com&quot;</span>);</span><br><span class="line">message.setTo(<span class="string">&quot;xxx@qq.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">javaMailSender.send(message);</span><br></pre></td></tr></table></figure>

<p><strong>复杂邮件发送</strong></p>
<p>带有附件或html页面的邮件</p>
<p><strong>两个设置</strong></p>
<p><code>new MimeMessageHelper(message,true)</code>    设置multipart=true，开启对内联元素和附件的支持</p>
<p><code>helper.setText(&quot;xxxx&quot;,true)</code>    html=ture，设置content type=text/html，默认为text/plain</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MimeMessage message = javaMailSender.createMimeMessage();</span><br><span class="line"><span class="comment">//multipart=true</span></span><br><span class="line"><span class="comment">//开启对内联元素和附件的支持</span></span><br><span class="line">MimeMessageHelper helper = <span class="keyword">new</span> MimeMessageHelper(message,<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">helper.setSubject(<span class="string">&quot;今天开会&quot;</span>);</span><br><span class="line"><span class="comment">//html=ture</span></span><br><span class="line"><span class="comment">//设置content type=text/html，默认为text/plain</span></span><br><span class="line">helper.setText(<span class="string">&quot;&lt;b style=&#x27;color:red&#x27;&gt;物质楼555开会，不要迟到&lt;/b&gt;&quot;</span>,<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">helper.setFrom(<span class="string">&quot;hongshengmo@163.com&quot;</span>);</span><br><span class="line">helper.setTo(<span class="string">&quot;1043245239@qq.com&quot;</span>);</span><br><span class="line"><span class="comment">//设置附件</span></span><br><span class="line">helper.addAttachment(<span class="string">&quot;2.png&quot;</span>,<span class="keyword">new</span> File(<span class="string">&quot;D:\\Works\\Note\\images\\图片2.png&quot;</span>));</span><br><span class="line">helper.addAttachment(<span class="string">&quot;3.png&quot;</span>,<span class="keyword">new</span> File(<span class="string">&quot;D:\\Works\\Note\\images\\图片3.png&quot;</span>));</span><br><span class="line">javaMailSender.send(message);</span><br></pre></td></tr></table></figure>

<h1 id="五-Spring-boot与安全"><a href="#五-Spring-boot与安全" class="headerlink" title="(五) Spring boot与安全"></a>(五) Spring boot与安全</h1><h2 id="一、安全"><a href="#一、安全" class="headerlink" title="一、安全"></a>一、安全</h2><p> 应用程序的两个主要区域是“认证”和“授权”（或者访问控制），这两个主要区域是安全的两个目标。    身份验证意味着<strong>确认您自己的身份</strong>，而授权意味着<strong>授予对系统的访问权限</strong></p>
<p><strong>认证</strong></p>
<p>身份验证是关于验证您的凭据，如用户名/用户ID和密码，以验证您的身份。系统确定您是否就是您所说的使用凭据。在公共和专用网络中，系统通过登录密码验证用户身份。身份验证通常通过用户名和密码完成，</p>
<p><strong>授权</strong></p>
<p>另一方面，授权发生在系统成功验证您的身份后，最终会授予您访问资源（如信息，文件，数据库，资金，位置，几乎任何内容）的完全权限。简单来说，授权决定了您访问系统的能力以及达到的程度。验证成功后，系统验证您的身份后，即可授权您访问系统资源。</p>
<h2 id="二、Spring-Security"><a href="#二、Spring-Security" class="headerlink" title="二、Spring Security"></a>二、Spring Security</h2><p>Spring Security是针对Spring项目的安全框架，也是Spring Boot底层安全模块默认的技术选型。他可以实现强大的web安全控制。对于安全控制，我们仅需引入<code>spring-boot-starter-security</code>模块，进行少量的配置，即可实现强大的安全管理。</p>
<p><strong>WebSecurityConfigurerAdapter：自定义Security策略</strong></p>
<p>通过在配置类中继承该类重写<code>configure(HttpSecurity http)</code>方法来实现自定义策略</p>
<p><strong>@EnableWebSecurity：开启WebSecurity模式</strong></p>
<p>在配置类上标注<code>@EnableWebSecurity</code>开启WebSecurity模式</p>
<h2 id="三、-Springboot整合security"><a href="#三、-Springboot整合security" class="headerlink" title="三、 Springboot整合security"></a>三、 Springboot整合security</h2><h3 id="1-导入依赖"><a href="#1-导入依赖" class="headerlink" title="1. 导入依赖"></a>1. 导入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>导入spring security的包之后，默认情况所有应用访问认证授权，默认用户名user，密码为随机生成的uuid，启动时打印在控制台</p>
<h3 id="2-登录-注销"><a href="#2-登录-注销" class="headerlink" title="2. 登录/注销"></a>2. 登录/注销</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//根目录允许所有人访问，其他目录都需要对应角色</span></span><br><span class="line">        http.authorizeRequests().antMatchers(<span class="string">&quot;/&quot;</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/level1/**&quot;</span>).hasRole(<span class="string">&quot;VIP1&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/level2/**&quot;</span>).hasRole(<span class="string">&quot;VIP2&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/level3/**&quot;</span>).hasRole(<span class="string">&quot;VIP3&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//开启自动配置的登陆功能，效果，如果没有登陆，没有权限就会来到登陆页面</span></span><br><span class="line">        <span class="comment">//	/login来到登陆页</span></span><br><span class="line">        <span class="comment">//	重定向到/login?error表示登陆失败</span></span><br><span class="line">        http.formLogin();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//开启自动配置的注销功能</span></span><br><span class="line">        <span class="comment">//向/logout发送post请求表示注销</span></span><br><span class="line">        http.logout();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时除了主页，点击其他的页面都会自动跳转到security自动生成的登录页面，<code>/login</code>来到登陆页,重定向到<code>/login?error</code>表示登陆失败；</p>
<p><code> http.logout()</code>开启自动配置的注销功能,向<code>/logout</code>发送post请求表示注销,需要在欢迎页加上注销表单，默认注销后自动跳转到登录页面，若想改变转发路径，可以通过<code>logoutSuccessUrl(url)</code>设置路径</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/logout&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;注销&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="3-定义认证规则"><a href="#3-定义认证规则" class="headerlink" title="3. 定义认证规则"></a>3. 定义认证规则</h3><p>为了保证密码能安全存储，springboot内置<code>PasswordEncoder</code>对密码进行转码，默认密码编码器为<code>DelegatingPasswordEncoder</code>。在定义认证规则时，我们需要使用<code>PasswordEncoder</code>将密码转码，由于<code>withDefaultPasswordEncoder()</code>并非安全已被弃用，因此仅在测试中使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserDetailsService <span class="title">users</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//使用默认的PasswordEncoder</span></span><br><span class="line">    User.UserBuilder builder = User.withDefaultPasswordEncoder();</span><br><span class="line">    <span class="comment">//定义账户用户名、密码、权限</span></span><br><span class="line">    UserDetails user1 = builder.username(<span class="string">&quot;zhangsan&quot;</span>)</span><br><span class="line">            .password(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">            .roles(<span class="string">&quot;VIP1&quot;</span>, <span class="string">&quot;VIP2&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">    UserDetails user2 = builder.username(<span class="string">&quot;lisi&quot;</span>)</span><br><span class="line">            .password(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">            .roles(<span class="string">&quot;VIP3&quot;</span>, <span class="string">&quot;VIP2&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">    UserDetails user3 = builder.username(<span class="string">&quot;wangwu&quot;</span>)</span><br><span class="line">            .password(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">            .roles(<span class="string">&quot;VIP1&quot;</span>, <span class="string">&quot;VIP3&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">    <span class="comment">//使用内存保存用户信息</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> InMemoryUserDetailsManager(user1,user2,user3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-自定义欢迎页"><a href="#4-自定义欢迎页" class="headerlink" title="4.自定义欢迎页"></a>4.自定义欢迎页</h3><p><strong>导入依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf.extras<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-extras-springsecurity5<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>引入命名空间</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">xmlns:sec</span>=<span class="string">&quot;http://www.thymeleaf.org/extras/spring-security&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>根据是否登录显示游客或用户信息</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 未登录显示此div --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">sec:authorize</span>=<span class="string">&quot;!isAuthenticated()&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">h2</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span>&gt;</span>游客您好，如果想查看武林秘籍 <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/userlogin&#125;&quot;</span>&gt;</span>请登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 登录显示此div --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">sec:authorize</span>=<span class="string">&quot;isAuthenticated()&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 显示用户名 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">h2</span>&gt;</span>尊敬的<span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;#authentication.name&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>,您好！您的角色有：</span><br><span class="line">       <span class="comment">&lt;!-- 显示用户角色 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;#authentication.authorities&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/logout&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;注销&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>根据角色类型显示信息</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 具有VIP1的角色显示以下div --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">sec:authorize</span>=<span class="string">&quot;hasRole(&#x27;VIP1&#x27;)&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">h3</span>&gt;</span>普通武功秘籍<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/level1/1&#125;&quot;</span>&gt;</span>罗汉拳<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/level1/2&#125;&quot;</span>&gt;</span>武当长拳<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/level1/3&#125;&quot;</span>&gt;</span>全真剑法<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/thymeleaf/thymeleaf-extras-springsecurity">更多spring-security与thymeleaf整合教程</a></p>
<h3 id="5-自定义登录页-记住我"><a href="#5-自定义登录页-记住我" class="headerlink" title="5. 自定义登录页/记住我"></a>5. 自定义登录页/记住我</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//定制登录页</span></span><br><span class="line">    http.formLogin()</span><br><span class="line">            .usernameParameter(<span class="string">&quot;user&quot;</span>)  <span class="comment">//表单用户名name</span></span><br><span class="line">            .passwordParameter(<span class="string">&quot;pwd&quot;</span>)   <span class="comment">//表单密码name</span></span><br><span class="line">            .loginPage(<span class="string">&quot;/userlogin&quot;</span>);   <span class="comment">//定制登陆页路径</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//开启记住我</span></span><br><span class="line">    http.rememberMe().</span><br><span class="line">        rememberMeParameter(<span class="string">&quot;rem&quot;</span>);		<span class="comment">//设置表单记住我name值</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>loginPage(url)</code>设置登录页路径后，在定制的登录页发送<code>post url</code>即为登录请求，并设置表单的<code>name</code>属性都为对应值；</p>
<p>通过勾选<code>记住我</code>，session退出后依然能通过<code>cookie</code>保存用户信息，下次免登陆</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/userlogin&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">   用户名:<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">   密码:<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;pwd&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;rem&quot;</span>&gt;</span>记住我<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;登陆&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/site/docs/5.3.2.BUILD-SNAPSHOT/reference/html5/">更多spring-security参阅官方文档</a></p>
<h1 id="六-Spring-boot与分布式"><a href="#六-Spring-boot与分布式" class="headerlink" title="(六) Spring boot与分布式"></a>(六) Spring boot与分布式</h1><h2 id="一、分布式应用"><a href="#一、分布式应用" class="headerlink" title="一、分布式应用"></a>一、分布式应用</h2><p>​        分布式应用（distributed application）指的是应用程序分布在不同计算机上，通过网络来共同完成一项任务的工作方式。</p>
<p><strong>为什么需要分布式？</strong></p>
<ul>
<li><strong>单一应用架构</strong><br>当网站流量很小时，只需一个应用，将所有功能都部署在一起，以减少部署节点和成本。此时，用于简化增删改查工作量的数据访问框架(ORM)是关键。</li>
<li><strong>垂直应用架构</strong><br>当访问量逐渐增大，单一应用增加机器带来的加速度越来越小，将应用拆成互不相干的几个应用，以提升效率。此时，用于加速前端页面开发的Web框架(MVC)是关键。</li>
<li><strong>分布式服务架构</strong><br>当垂直应用越来越多，应用之间交互不可避免，将核心业务抽取出来，作为独立的服务，逐渐形成稳定的服务中心，使前端应用能更快速的响应多变的市场需求。此时，用于提高业务复用及整合的分布式服务框架(RPC)是关键。<ul>
<li><strong>流动计算架构</strong><br>当服务越来越多，容量的评估，小服务资源的浪费等问题逐渐显现，此时需增加一个调度中心基于访问压力实时管理集群容量，提高集群利用率。此时，用于提高机器利用率的资源调度和治理中心(SOA)是关键。</li>
</ul>
</li>
</ul>
<p>在分布式系统中，国内常用zookeeper+dubbo组合，而Spring Boot推荐使用全栈的Spring，Spring Boot+Spring Cloud。</p>
<h2 id="二、Zookeeper和Dubbo"><a href="#二、Zookeeper和Dubbo" class="headerlink" title="二、Zookeeper和Dubbo"></a>二、Zookeeper和Dubbo</h2><h3 id="1-概述-1"><a href="#1-概述-1" class="headerlink" title="1. 概述"></a>1. 概述</h3><p><strong>ZooKeeper</strong><br>ZooKeeper 是一个分布式的，开放源码的分布式应用程序协调服务。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。</p>
<p><strong>Dubbo</strong><br>Dubbo是Alibaba开源的分布式服务框架，它最大的特点是按照分层的方式来架构，使用这种方式可以使各个层之间解耦合（或者最大限度地松耦合）。从服务模型的角度来看，Dubbo采用的是一种非常简单的模型，要么是提供方提供服务，要么是消费方消费服务，所以基于这一点可以抽象出服务提供方（Provider）和服务消费方（Consumer）两个角色。</p>
<h3 id="2-整合springboot"><a href="#2-整合springboot" class="headerlink" title="2. 整合springboot"></a>2. 整合springboot</h3><p><strong>环境搭建</strong></p>
<p>分别创建provider和consumer模块并分别导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 导入dubbo与springboot整合启动器 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">&lt;!-- 导入zookeeper客户端 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.sgroschupf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 导入zookeeper客户端所需依赖：curator框架 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>provider配置文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 应用项目名</span></span><br><span class="line"><span class="meta">dubbo.application.name</span>=<span class="string">provider-ticket</span></span><br><span class="line"><span class="comment"># zookeeper地址</span></span><br><span class="line"><span class="meta">dubbo.registry.address</span>=<span class="string">zookeeper://192.168.31.162:2181</span></span><br><span class="line"><span class="comment"># dubbo扫描包路径        </span></span><br><span class="line"><span class="meta">dubbo.scan.base-packages</span>=<span class="string">cn.edu.ustc.service</span></span><br></pre></td></tr></table></figure>

<p>consumer配置文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">dubbo.application.name</span>=<span class="string">consumer-user</span></span><br><span class="line"><span class="meta">dubbo.registry.address</span>=<span class="string">zookeeper://192.168.31.162:2181</span></span><br></pre></td></tr></table></figure>

<p><strong>生产者服务</strong></p>
<p><code>@EnableDubbo</code> ：</p>
<p>可以在指定的包名下（通过 <code>scanBasePackages</code>），或者指定的类中（通过 <code>scanBasePackageClasses</code>）扫描 Dubbo 的服务提供者（以 <code>@Service</code> 标注）以及 Dubbo 的服务消费者（以 <code>Reference</code> 标注）。</p>
<p><code>@Service</code>：</p>
<p>表示服务的具体实现，被注解的类会被dubbo扫描</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.Service;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.spring.context.annotation.EnableDubbo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableDubbo</span> <span class="comment">//开启对dubbo支持</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Service</span> <span class="comment">//标记此类，表示服务的具体实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TicketServiceImpl</span> <span class="keyword">implements</span> <span class="title">TicketService</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTicket</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Gxx:合肥-北京&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>消费者服务</strong></p>
<p>编写与分布式服务类相同的接口(不必实现)，并保证包结构相同</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TicketService</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getTicket</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@Reference 可以定义在类中的一个字段、方法上，表示一个服务的引用。通常 @Reference 定义在一个字段上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Reference</span></span><br><span class="line">    TicketService ticketService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String ticket = ticketService.getTicket();</span><br><span class="line">        System.out.println(<span class="string">&quot;买到票了:&quot;</span>+ticket);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时若调用<code>hello()</code>,控制台将打印</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">买到票了:Gxx:合肥-北京</span><br></pre></td></tr></table></figure>



<p><strong>有关dubbo更多</strong></p>
<p><a target="_blank" rel="noopener" href="http://dubbo.apache.org/zh-cn/blog/dubbo-annotation.html">dubbo注解详细解释</a></p>
<p><a target="_blank" rel="noopener" href="http://dubbo.apache.org/zh-cn/blog/dubbo-zk.html">dubbo与zookeeper官方整合案例</a></p>
<h2 id="三、Spring-Cloud"><a href="#三、Spring-Cloud" class="headerlink" title="三、Spring Cloud"></a>三、Spring Cloud</h2><h3 id="1-概述-2"><a href="#1-概述-2" class="headerlink" title="1. 概述"></a>1. 概述</h3><p>Spring Cloud是一个分布式的整体解决方案。Spring Cloud 为开发者提供了在分布式系统（配置管理，服务发现，熔断，路由，微代理，控制总线，一次性token，全局琐，leader选举，分布式session，集群状态）中快速构建的工具，使用Spring Cloud的开发者可以快速的启动服务或构建应用、同时能够快速和云平台资源进行对接。</p>
<p>SpringCloud分布式开发五大常用组件</p>
<ul>
<li>服务发现——Netflix Eureka</li>
<li>客服端负载均衡——Netflix Ribbon</li>
<li>断路器——Netflix Hystrix</li>
<li>服务网关——Netflix Zuul</li>
<li>分布式配置——Spring Cloud Config</li>
</ul>
<h3 id="2-入门"><a href="#2-入门" class="headerlink" title="2. 入门"></a>2. 入门</h3><p><strong>Eureka注册中心</strong></p>
<p>创建工程导入<code>eureka-server</code>模块</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       ...</span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka-server</span>  <span class="comment"># eureka实例的主机名</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="comment">#不把自己注册到eureka上</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span> <span class="comment">#不从eureka上来获取服务的注册信息</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span></span><br></pre></td></tr></table></figure>

<p><strong>生产者模块</strong></p>
<p>创建工程导入<code>eureka-client</code>和<code>web</code>模块</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8002</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: provider-ticket</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    prefer-ip-address: true # 注册服务的时候使用服务的ip地址</span><br><span class="line">  client:</span><br><span class="line">    service-url:</span><br><span class="line">      defaultZone: http:&#x2F;&#x2F;localhost:8761&#x2F;eureka&#x2F;</span><br></pre></td></tr></table></figure>

<p>编写controller层和service层demo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TicketService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTicket</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;8002&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;《厉害了，我的国》&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TicketController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    TicketService ticketService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/ticket&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTicket</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ticketService.getTicket();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>消费者模块</strong></p>
<p>创建工程导入<code>eureka-client</code>和<code>web</code>模块</p>
<p>配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consumer-user</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8200</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment"># 注册服务的时候使用服务的ip地址</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span></span><br></pre></td></tr></table></figure>



<p>向容器中注入<code>RestTemplate</code>, 并使用<code>@EnableDiscoveryClient</code>开启发现服务功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span> <span class="comment">//开启发现服务功能</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerUserApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConsumerUserApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@LoadBalanced</span> <span class="comment">//使用负载均衡机制</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>编写controller并使用<code>RestTemplate</code>发现服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/buy&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">buyTicket</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        String s = restTemplate.getForObject(<span class="string">&quot;http://PROVIDER-TICKET/ticket&quot;</span>, String.class);</span><br><span class="line">        <span class="keyword">return</span> name+<span class="string">&quot;购买了&quot;</span>+s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>向<code>http://localhost:8200/buy?username=zhangsan</code>发请求，则会响应</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zhangsan购买了《厉害了，我的国》</span><br></pre></td></tr></table></figure>

<p>并且在使用了<code>@LoadBalanced</code>之后实现了负载均衡，如果创建不同端口的<code>provider</code>应用，则访问会被均衡到各个应用</p>
<h1 id="七-Spring-boot与热部署"><a href="#七-Spring-boot与热部署" class="headerlink" title="(七) Spring boot与热部署"></a>(七) Spring boot与热部署</h1><p> 在开发中我们修改一个Java文件后想看到效果不得不重启应用，这导致大量时间花费，我们希望不重启应用的情况下，程序可以自动部署（热部署）。有以下四种情况，如何能实现热部署。</p>
<h2 id="一、模板引擎"><a href="#一、模板引擎" class="headerlink" title="一、模板引擎"></a>一、模板引擎</h2><p>在Spring Boot中开发情况下禁用模板引擎的cache<br>页面模板改变ctrl+F9可以重新编译当前页面并生效</p>
<h2 id="二、Spring-Loaded"><a href="#二、Spring-Loaded" class="headerlink" title="二、Spring Loaded"></a>二、Spring Loaded</h2><p>Spring官方提供的热部署程序，实现修改类文件的热部署</p>
<ul>
<li>下载Spring Loaded（项目地址<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-loaded%EF%BC%89">https://github.com/spring-projects/spring-loaded）</a></li>
<li>添加运行时参数；<ul>
<li>javaagent:C:/springloaded-1.2.5.RELEASE.jar –noverify</li>
</ul>
</li>
</ul>
<h2 id="三、JRebel"><a href="#三、JRebel" class="headerlink" title="三、JRebel"></a>三、JRebel</h2><p>收费的一个热部署软件<br>安装插件使用即可</p>
<h2 id="四、-Spring-Boot-Devtools（推荐）"><a href="#四、-Spring-Boot-Devtools（推荐）" class="headerlink" title="四、 Spring Boot Devtools（推荐）"></a>四、 Spring Boot Devtools（推荐）</h2><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>IDEA使用ctrl+F9重新编译实现热部署</p>
<h1 id="八-Spring-Boot与监控管理"><a href="#八-Spring-Boot与监控管理" class="headerlink" title="(八) Spring Boot与监控管理"></a>(八) Spring Boot与监控管理</h1><p>通过引入spring-boot-starter-actuator，可以使用Spring Boot为我们提供的准生产环境下的应用监控和管理功能。我们可以通过HTTP，JMX，SSH协议来进行操作，自动得到审计、健康及指标信息等</p>
<h2 id="一、-Actuator监控管理"><a href="#一、-Actuator监控管理" class="headerlink" title="一、 Actuator监控管理"></a>一、 Actuator监控管理</h2><p><strong>导入依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>浏览器打开链接<code>http://localhost:8080/actuator/</code>,可以看到所有支持的连接，响应如下,默认只支持这些端点</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;_links&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;self&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;href&quot;</span>: <span class="string">&quot;http://localhost:8080/actuator&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;templated&quot;</span>: <span class="literal">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;health&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;href&quot;</span>: <span class="string">&quot;http://localhost:8080/actuator/health&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;templated&quot;</span>: <span class="literal">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;health-path&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;href&quot;</span>: <span class="string">&quot;http://localhost:8080/actuator/health/&#123;*path&#125;&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;templated&quot;</span>: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;info&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;href&quot;</span>: <span class="string">&quot;http://localhost:8080/actuator/info&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;templated&quot;</span>: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果要看到所有支持的状态查询，需要配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">management.endpoints.web.exposure.include</span>=<span class="string">*</span></span><br></pre></td></tr></table></figure>

<p>bean加载情况<code>http://localhost:8080/actuator/beans</code>,显示了容器中各类各项属性</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;contexts&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;application&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;beans&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;endpointCachingOperationInvokerAdvisor&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;aliases&quot;</span>: [],</span><br><span class="line">                    <span class="attr">&quot;scope&quot;</span>: <span class="string">&quot;singleton&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;org.springframework.boot.actuate.endpoint.invoker.cache.CachingOperationInvokerAdvisor&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;resource&quot;</span>: <span class="string">&quot;class path resource [org/springframework/boot/actuate/autoconfigure/endpoint/EndpointAutoConfiguration.class]&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;dependencies&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;environment&quot;</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;defaultServletHandlerMapping&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;aliases&quot;</span>: [],</span><br><span class="line">                    <span class="attr">&quot;scope&quot;</span>: <span class="string">&quot;singleton&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;org.springframework.web.servlet.HandlerMapping&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;resource&quot;</span>: <span class="string">&quot;class path resource [org/springframework/boot/autoconfigure/web/servlet/WebMvcAutoConfiguration$EnableWebMvcConfiguration.class]&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;dependencies&quot;</span>: []</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br></pre></td></tr></table></figure>



<h2 id="二、-端点配置"><a href="#二、-端点配置" class="headerlink" title="二、 端点配置"></a>二、 端点配置</h2><p>默认情况下，除shutdown以外的所有端点均已启用。要配置单个端点的启用，请使用<code>management.endpoint.&lt;id&gt;.enabled</code>属性。以下示例启用<code>shutdown</code>端点：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">management.endpoint.shutdown.enabled</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>另外可以通过<code>management.endpoints.enabled-by-default</code>来修改全局端口默认配置,以下示例启用info端点并禁用所有其他端点：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">management.endpoints.enabled-by-default</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">management.endpoint.info.enabled</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>修改路径</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改根目录路径</span></span><br><span class="line"><span class="meta">management.endpoints.web.base-path</span>=<span class="string">/management</span></span><br><span class="line"><span class="comment"># 修改/health路径</span></span><br><span class="line"><span class="meta">management.endpoints.web.path-mapping.health</span>=<span class="string">healthcheck</span></span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/2.2.6.RELEASE/reference/html/production-ready-features.html#production-ready-endpoints">更多参阅spring-actuator官方文档</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/10/26/Spring%20Boot-%E9%AB%98%E7%BA%A7%E7%AF%87/" data-id="ckgqaivsm00028ovld5sc3ebl" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2020/10/26/Spring%20Boot%E7%AC%94%E8%AE%B0/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">spring-boot笔记-初级</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/10/26/Spring%20Boot-%E9%AB%98%E7%BA%A7%E7%AF%87/">Spring Boot-高级篇</a>
          </li>
        
          <li>
            <a href="/2020/10/26/Spring%20Boot%E7%AC%94%E8%AE%B0/">spring-boot笔记-初级</a>
          </li>
        
          <li>
            <a href="/2020/10/26/%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AF%87%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0/">我的第一篇博客文章</a>
          </li>
        
          <li>
            <a href="/2020/10/26/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>